<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System - LightNVR</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
</head>
<body class="flex flex-col min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
<div class="container mx-auto px-4 flex flex-col min-h-screen">
    <header id="header-container">
        <!-- Header content will be loaded by JavaScript -->
    </header>

    <main id="main-content" class="flex-grow">
        <section id="system-page" class="page" x-data="systemManager">
            <div class="page-header flex justify-between items-center mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                <h2 class="text-xl font-bold">System</h2>
                <div class="controls">
                    <button id="refresh-system-btn" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 flex items-center"
                            @click="refreshSystemInfo">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="system-container grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="system-group bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">System Information</h3>
                    <div class="space-y-3">
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Version:</span>
                            <span class="value bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded" id="system-version" x-text="systemInfo.version">0.2.0</span>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Uptime:</span>
                            <span class="value" id="system-uptime" x-text="systemInfo.uptime">0d 0h 0m</span>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">CPU Usage:</span>
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mr-2 overflow-hidden">
                                    <div class="bg-blue-600 h-2.5 rounded-full" :style="`width: ${systemInfo.cpuUsage}%`"></div>
                                </div>
                                <span class="value" id="system-cpu" x-text="`${systemInfo.cpuUsage}%`">0%</span>
                            </div>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Memory Usage:</span>
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mr-2 overflow-hidden">
                                    <div class="bg-blue-600 h-2.5 rounded-full" :style="`width: ${systemInfo.memoryPercentage}%`"></div>
                                </div>
                                <span class="value" id="system-memory" x-text="systemInfo.memory">0 MB / 256 MB</span>
                            </div>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Storage Usage:</span>
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mr-2 overflow-hidden">
                                    <div class="bg-blue-600 h-2.5 rounded-full" :style="`width: ${systemInfo.storagePercentage}%`"></div>
                                </div>
                                <span class="value" id="system-storage" x-text="systemInfo.storage">0 GB / 0 GB</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="system-group bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">Stream Statistics</h3>
                    <div class="space-y-3">
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Active Streams:</span>
                            <span class="value" id="system-active-streams" x-text="streamStats.activeStreams">0 / 0</span>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Recording Streams:</span>
                            <span class="value" id="system-recording-streams" x-text="streamStats.recordingStreams">0</span>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Total Received:</span>
                            <span class="value" id="system-received" x-text="streamStats.totalReceived">0 MB</span>
                        </div>
                        <div class="info-item flex justify-between items-center">
                            <span class="label font-medium">Total Recorded:</span>
                            <span class="value" id="system-recorded" x-text="streamStats.totalRecorded">0 MB</span>
                        </div>
                    </div>
                </div>
                <div class="system-group bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                    <h3 class="text-lg font-medium mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">System Actions</h3>
                    <div class="action-buttons grid grid-cols-2 gap-3">
                        <button id="restart-btn" 
                                class="btn-warning px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600 transition-colors"
                                @click="restartService">
                            Restart Service
                        </button>
                        <button id="shutdown-btn" 
                                class="btn-danger px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                                @click="shutdownService">
                            Shutdown Service
                        </button>
                        <button id="clear-logs-btn" 
                                class="btn px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                                @click="clearLogs">
                            Clear Logs
                        </button>
                        <button id="backup-config-btn" 
                                class="btn px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                                @click="backupConfig">
                            Backup Configuration
                        </button>
                    </div>
                </div>
                <div class="system-group bg-white dark:bg-gray-800 rounded-lg shadow p-4 md:col-span-2">
                    <h3 class="text-lg font-medium mb-4 pb-2 border-b border-gray-200 dark:border-gray-700">System Logs</h3>
                    <div class="log-container bg-gray-100 dark:bg-gray-900 rounded p-2 h-64 overflow-auto">
                        <pre id="system-logs" class="text-sm font-mono whitespace-pre-wrap" x-text="logs">No logs available</pre>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="footer-container" class="mt-auto">
        <!-- Footer content will be loaded by JavaScript -->
    </footer>
</div>

<!-- Toast notifications will be handled by toast.js -->

<!-- Confirmation Modal -->
<div id="confirm-modal" 
     x-data="modal('confirm-modal')"
     class="modal"
     :class="{ 'block': isOpen, 'hidden': !isOpen }">
    <div class="modal-content max-w-md mx-auto">
        <div class="modal-header">
            <h3 id="confirm-title" class="text-lg font-medium">Confirmation</h3>
            <span class="close" @click="close">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirm-message">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer">
            <button id="confirm-yes-btn" 
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                    @click="$store.confirmModal.confirm()">
                Yes
            </button>
            <button id="confirm-no-btn" 
                    class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
                    @click="close">
                No
            </button>
        </div>
    </div>
</div>

<script src="js/alpine.cdn.min.js" defer></script>
<script src="js/tailwind.cdn.min.js"></script>
<script src="js/core.js"></script>
<script src="js/components/layout.alpine.js"></script>
<script src="js/components/toast.js"></script>
<script src="js/components/ui.alpine.js"></script>
<script src="js/components/ui.js"></script>
<script src="js/components/system.js"></script>
<script src="js/pages/pages.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        // Confirmation modal store
        Alpine.store('confirmModal', {
            title: 'Confirmation',
            message: 'Are you sure you want to proceed?',
            callback: null,
            
            open(title, message, callback) {
                this.title = title;
                this.message = message;
                this.callback = callback;
                
                const modal = document.getElementById('confirm-modal');
                if (modal && modal.__x) {
                    // Update title and message
                    document.getElementById('confirm-title').textContent = title;
                    document.getElementById('confirm-message').textContent = message;
                    
                    // Open modal
                    modal.__x.Alpine.data.open();
                }
            },
            
            confirm() {
                if (typeof this.callback === 'function') {
                    this.callback();
                }
                
                // Close modal
                const modal = document.getElementById('confirm-modal');
                if (modal && modal.__x) {
                    modal.__x.Alpine.data.close();
                }
            }
        });
        
        Alpine.data('systemManager', () => ({
            systemInfo: {
                version: '0.2.0',
                uptime: '0d 0h 0m',
                cpuUsage: 0,
                memory: '0 MB / 256 MB',
                memoryPercentage: 0,
                storage: '0 GB / 0 GB',
                storagePercentage: 0
            },
            streamStats: {
                activeStreams: '0 / 0',
                recordingStreams: '0',
                totalReceived: '0 MB',
                totalRecorded: '0 MB'
            },
            logs: 'Loading logs...',
            
            init() {
                this.loadSystemInfo();
                
                // Refresh system info every 30 seconds
                setInterval(() => {
                    this.loadSystemInfo();
                }, 30000);
            },
            
            async loadSystemInfo() {
                try {
                    // Fetch system info
                    const response = await fetch('/api/system');
                    if (!response.ok) {
                        throw new Error('Failed to load system information');
                    }
                    
                    const data = await response.json();
                    
                    // Update system info
                    this.systemInfo = {
                        version: data.version || '0.2.0',
                        uptime: this.formatUptime(data.uptime_seconds || 0),
                        cpuUsage: data.cpu_usage || 0,
                        memory: `${this.formatSize(data.memory_used || 0)} / ${this.formatSize(data.memory_total || 0)}`,
                        memoryPercentage: data.memory_total ? Math.round((data.memory_used / data.memory_total) * 100) : 0,
                        storage: `${this.formatSize(data.storage_used || 0)} / ${this.formatSize(data.storage_total || 0)}`,
                        storagePercentage: data.storage_total ? Math.round((data.storage_used / data.storage_total) * 100) : 0
                    };
                    
                    // Update stream stats
                    this.streamStats = {
                        activeStreams: `${data.active_streams || 0} / ${data.total_streams || 0}`,
                        recordingStreams: data.recording_streams || 0,
                        totalReceived: this.formatSize(data.total_received || 0),
                        totalRecorded: this.formatSize(data.total_recorded || 0)
                    };
                    
                    // Load logs
                    this.loadLogs();
                } catch (error) {
                    console.error('Error loading system information:', error);
                    Alpine.store('statusMessage').show('Error loading system information: ' + error.message);
                }
            },
            
            async loadLogs() {
                try {
                    const response = await fetch('/api/system/logs');
                    if (!response.ok) {
                        throw new Error('Failed to load system logs');
                    }
                    
            const data = await response.json();
            this.logs = Array.isArray(data.logs) ? data.logs.join('\n') : (data.logs || 'No logs available');
                    
                    // Scroll to bottom of logs
                    const logContainer = document.querySelector('.log-container');
                    if (logContainer) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error loading system logs:', error);
                    this.logs = 'Error loading logs: ' + error.message;
                }
            },
            
            refreshSystemInfo() {
                this.loadSystemInfo();
                Alpine.store('statusMessage').show('System information refreshed');
            },
            
            restartService() {
                Alpine.store('confirmModal').open(
                    'Restart Service',
                    'Are you sure you want to restart the LightNVR service? All active streams will be disconnected.',
                    async () => {
                        try {
                            const response = await fetch('/api/system/restart', {
                                method: 'POST'
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to restart service');
                            }
                            
                            Alpine.store('statusMessage').show('Service restart initiated. Please wait...');
                            
                            // Wait for service to restart
                            setTimeout(() => {
                                this.loadSystemInfo();
                            }, 5000);
                        } catch (error) {
                            console.error('Error restarting service:', error);
                            Alpine.store('statusMessage').show('Error restarting service: ' + error.message);
                        }
                    }
                );
            },
            
            shutdownService() {
                Alpine.store('confirmModal').open(
                    'Shutdown Service',
                    'Are you sure you want to shutdown the LightNVR service? All active streams will be disconnected and the service will stop running.',
                    async () => {
                        try {
                            const response = await fetch('/api/system/shutdown', {
                                method: 'POST'
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to shutdown service');
                            }
                            
                            Alpine.store('statusMessage').show('Service shutdown initiated. The service is now stopping...');
                        } catch (error) {
                            console.error('Error shutting down service:', error);
                            Alpine.store('statusMessage').show('Error shutting down service: ' + error.message);
                        }
                    }
                );
            },
            
            clearLogs() {
                Alpine.store('confirmModal').open(
                    'Clear Logs',
                    'Are you sure you want to clear all system logs?',
                    async () => {
                        try {
                            const response = await fetch('/api/system/logs/clear', {
                                method: 'POST'
                            });
                            
                            if (!response.ok) {
                                throw new Error('Failed to clear logs');
                            }
                            
                            // Use the new toast system if available
                            if (typeof showSuccessToast === 'function') {
                                showSuccessToast('System logs cleared');
                            } else {
                                // Fallback to old method
                                showStatusMessage('System logs cleared', 5000);
                            }
                            
                            // Reload logs to show the cleared state
                            fetch('/api/system/logs')
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to load system logs');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    const logsContainer = document.getElementById('system-logs');
                                    if (logsContainer) {
                                        if (data.logs && Array.isArray(data.logs)) {
                                            logsContainer.textContent = data.logs.join('\n');
                                        } else {
                                            logsContainer.textContent = 'No logs available';
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Error loading system logs:', error);
                                    if (typeof showErrorToast === 'function') {
                                        showErrorToast('Error loading system logs: ' + error.message);
                                    }
                                });
                        } catch (error) {
                            console.error('Error clearing logs:', error);
                            if (typeof showErrorToast === 'function') {
                                showErrorToast('Error clearing logs: ' + error.message);
                            } else {
                                Alpine.store('statusMessage').show('Error clearing logs: ' + error.message);
                            }
                        }
                    }
                );
            },
            
            async backupConfig() {
                try {
                    const response = await fetch('/api/system/backup');
                    if (!response.ok) {
                        throw new Error('Failed to create backup');
                    }
                    
                    const data = await response.json();
                    
                    if (data.backup_path) {
                        // Create download link
                        const link = document.createElement('a');
                        link.href = `/api/system/backup/download?path=${encodeURIComponent(data.backup_path)}`;
                        link.download = `lightnvr_backup_${new Date().toISOString().slice(0, 10)}.zip`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        Alpine.store('statusMessage').show('Configuration backup created and download started');
                    } else {
                        throw new Error('Backup path not provided');
                    }
                } catch (error) {
                    console.error('Error creating backup:', error);
                    Alpine.store('statusMessage').show('Error creating backup: ' + error.message);
                }
            },
            
            formatUptime(seconds) {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                return `${days}d ${hours}h ${minutes}m`;
            },
            
            formatSize(bytes) {
                if (bytes < 1024) {
                    return `${bytes} B`;
                } else if (bytes < 1024 * 1024) {
                    return `${(bytes / 1024).toFixed(1)} KB`;
                } else if (bytes < 1024 * 1024 * 1024) {
                    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
                } else {
                    return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
                }
            }
        }));
    });

    // Function to show status message using vanilla JS with toast fallback
    function showStatusMessage(message, duration = 5000, isError = false) {
        // Use the new toast system if available
        if (typeof showSuccessToast === 'function' && typeof showErrorToast === 'function') {
            if (isError) {
                showErrorToast(message, duration);
            } else {
                showSuccessToast(message, duration);
            }
            return;
        }
        
        // Fallback to old method if toast system not available
        const statusMessage = document.getElementById('status-message');
        if (!statusMessage) return;
        
        statusMessage.textContent = message;
        statusMessage.classList.add('visible');
        
        setTimeout(() => {
            statusMessage.classList.remove('visible');
        }, duration);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Load header and footer
        loadHeader('nav-system');
        loadFooter();
        

        // Add status message styles for toast notifications
        addStatusMessageStyles();
        
        // Initialize the system view
        setupSystemHandlers();
        
        // Add direct event listeners for system action buttons
        
        // Clear logs button
        const clearLogsBtn = document.getElementById('clear-logs-btn');
        if (clearLogsBtn) {
            clearLogsBtn.addEventListener('click', function() {
                console.log('Clear logs button clicked');
                if (confirm('Are you sure you want to clear all system logs?')) {
                    console.log('Clearing logs...');
                    fetch('/api/system/logs/clear', {
                        method: 'POST'
                    })
                    .then(response => {
                        console.log('Clear logs response:', response);
                        if (!response.ok) {
                            throw new Error('Failed to clear logs');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Clear logs success:', data);
                        
                        // Use the new toast system if available with longer duration
                        if (typeof showSuccessToast === 'function') {
                            showSuccessToast('System logs cleared', 8000);
                        } else {
                            showStatusMessage('System logs cleared', 5000);
                        }
                        
                        // Reload logs to show the cleared state
                        return fetch('/api/system/logs');
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load system logs');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Logs reloaded:', data);
                        const logsContainer = document.getElementById('system-logs');
                        if (logsContainer) {
                            if (data.logs && Array.isArray(data.logs)) {
                                logsContainer.textContent = data.logs.join('\n');
                            } else {
                                logsContainer.textContent = 'No logs available';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing logs:', error);
                        // Use the new toast system if available
                        if (typeof showErrorToast === 'function') {
                            showErrorToast('Error clearing logs: ' + error.message, 8000);
                        } else {
                            showStatusMessage('Error clearing logs: ' + error.message, 5000);
                        }
                    });
                }
            });
        }
        
        // Restart service button
        const restartBtn = document.getElementById('restart-btn');
        if (restartBtn) {
            restartBtn.addEventListener('click', function() {
                console.log('Restart button clicked');
                if (confirm('Are you sure you want to restart the LightNVR service? All active streams will be disconnected.')) {
                    console.log('Restarting service...');
                    fetch('/api/system/restart', {
                        method: 'POST'
                    })
                    .then(response => {
                        console.log('Restart response:', response);
                        if (!response.ok) {
                            throw new Error('Failed to restart service');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Restart success:', data);
                        showStatusMessage('Service restart initiated. Please wait...', 5000);
                        
                        // Wait for service to restart
                        setTimeout(() => {
                            // Reload system info
                            fetch('/api/system')
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to load system information');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('System info reloaded after restart:', data);
                                    // Update UI with new system info
                                    // This will be handled by Alpine.js
                                })
                                .catch(error => {
                                    console.error('Error loading system info after restart:', error);
                                });
                        }, 5000);
                    })
                    .catch(error => {
                        console.error('Error restarting service:', error);
                        showStatusMessage('Error restarting service: ' + error.message, 5000);
                    });
                }
            });
        }
        
        // Shutdown service button
        const shutdownBtn = document.getElementById('shutdown-btn');
        if (shutdownBtn) {
            shutdownBtn.addEventListener('click', function() {
                console.log('Shutdown button clicked');
                if (confirm('Are you sure you want to shutdown the LightNVR service? All active streams will be disconnected and the service will stop running.')) {
                    console.log('Shutting down service...');
                    fetch('/api/system/shutdown', {
                        method: 'POST'
                    })
                    .then(response => {
                        console.log('Shutdown response:', response);
                        if (!response.ok) {
                            throw new Error('Failed to shutdown service');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Shutdown success:', data);
                        showStatusMessage('Service shutdown initiated. The service is now stopping...', 5000);
                    })
                    .catch(error => {
                        console.error('Error shutting down service:', error);
                        showStatusMessage('Error shutting down service: ' + error.message, 5000);
                    });
                }
            });
        }
        
        // Backup configuration button
        const backupConfigBtn = document.getElementById('backup-config-btn');
        if (backupConfigBtn) {
            backupConfigBtn.addEventListener('click', function() {
                console.log('Backup config button clicked');
                console.log('Creating backup...');
                fetch('/api/system/backup')
                    .then(response => {
                        console.log('Backup response:', response);
                        if (!response.ok) {
                            throw new Error('Failed to create backup');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Backup success:', data);
                        if (data.backup_path) {
                            // Create download link
                            const link = document.createElement('a');
                            link.href = `/api/system/backup/download?path=${encodeURIComponent(data.backup_path)}`;
                            link.download = `lightnvr_backup_${new Date().toISOString().slice(0, 10)}.zip`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            showStatusMessage('Configuration backup created and download started', 5000);
                        } else {
                            throw new Error('Backup path not provided');
                        }
                    })
                    .catch(error => {
                        console.error('Error creating backup:', error);
                        showStatusMessage('Error creating backup: ' + error.message, 5000);
                    });
            });
        }
    });
</script>
</body>
</html>
