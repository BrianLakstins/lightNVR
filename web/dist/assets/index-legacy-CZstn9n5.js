System.register(["./query-client-legacy-BQ_U5NnD.js","./layout-legacy-CDxh3f01.js","./LiveView-legacy-BmOgsmPn.js","./Footer-legacy-B5sb7m6V.js"],(function(e,t){"use strict";var o,r,n,a,s,i,l,c,d,m,u,g,f,h,y,b,p,w;return{setters:[e=>{o=e.d,r=e.A,n=e.y,a=e.u,s=e.E,i=e.q,l=e.Q,c=e.k},null,e=>{d=e.s,m=e.c,u=e.t,g=e.L},e=>{f=e.s,h=e.a,y=e.b,b=e.c,p=e.H,w=e.F}],execute:function(){function e(){const[e,t]=o([]),[s,i]=o((()=>new URLSearchParams(window.location.search).get("layout")||"4")),[l,c]=o((()=>new URLSearchParams(window.location.search).get("stream")||"")),[g,p]=o(!1),[w,v]=o(!0),[x,C]=o((()=>{const e=new URLSearchParams(window.location.search).get("page");return e?Math.max(0,parseInt(e,10)-1):0})),T=r(null),S=r({}),$=r({});n((()=>{f(),h(),y();const t=setInterval((()=>{Object.keys(S.current).forEach((t=>{const o=S.current[t];if(o&&(console.debug(`WebRTC connection state for ${t}: ${o.connectionState}, ICE state: ${o.iceConnectionState}`),"failed"===o.iceConnectionState||"disconnected"===o.iceConnectionState)){console.warn(`WebRTC connection for ${t} is in ${o.iceConnectionState} state, will attempt reconnect`),W(t);const r=e.find((e=>e.name===t));r&&(console.log(`Attempting to reconnect WebRTC for stream ${t}`),E(r))}}))}),3e4);return()=>{clearInterval(t),j()}}),[e]),n((()=>{v(!0);const e=setTimeout((()=>{console.warn("Stream loading timed out"),v(!1),b("Loading streams timed out. Please try refreshing the page.")}),15e3);N().then((o=>{if(clearTimeout(e),o&&o.length>0){t(o);const e=new URLSearchParams(window.location.search).get("stream");e&&o.some((t=>t.name===e))?c(e):l&&o.some((e=>e.name===l))||c(o[0].name)}else console.warn("No streams returned from API");v(!1)})).catch((t=>{clearTimeout(e),console.error("Error loading streams:",t),b("Error loading streams: "+t.message),v(!1)}))}),[]);const N=async()=>{try{const e=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Request timed out"))),5e3)})),t=fetch("/api/streams"),o=await Promise.race([t,e]);if(!o.ok)throw new Error("Failed to load streams");const r=new Promise(((e,t)=>{setTimeout((()=>t(new Error("JSON parsing timed out"))),3e3)})),n=o.json(),a=(await Promise.race([n,r])||[]).map((e=>{const t=new Promise(((t,o)=>{setTimeout((()=>o(new Error(`Timeout fetching details for stream ${e.name}`))),3e3)})),o=fetch(`/api/streams/${encodeURIComponent(e.id||e.name)}`).then((t=>{if(!t.ok)throw new Error(`Failed to load details for stream ${e.name}`);return t.json()}));return Promise.race([o,t]).catch((t=>(console.error(`Error loading details for stream ${e.name}:`,t),e)))})),s=await Promise.all(a);console.log("Loaded detailed streams for WebRTC view:",s);const i=s.filter((e=>e.is_deleted?(console.log(`Stream ${e.name} is soft deleted, filtering out`),!1):e.enabled?!!e.streaming_enabled||(console.log(`Stream ${e.name} is not configured for HLS, filtering out`),!1):(console.log(`Stream ${e.name} is inactive, filtering out`),!1)));return console.log("Filtered streams for WebRTC view:",i),i||[]}catch(e){return console.error("Error loading streams for WebRTC view:",e),b("Error loading streams: "+e.message),[]}},k=()=>{switch(s){case"1":return 1;case"2":return 2;case"4":default:return 4;case"6":return 6;case"9":return 9;case"16":return 16}},E=e=>{const t=`video-${e.name.replace(/\s+/g,"-")}`,o=document.getElementById(t),r=o?o.closest(".video-cell"):null;if(!o||!r)return;const n=r.querySelector(".loading-indicator");n&&(n.style.display="flex");const a=`canvas-${e.name.replace(/\s+/g,"-")}`;let s=document.getElementById(a);s||(s=document.createElement("canvas"),s.id=a,s.className="detection-overlay",s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none",r.appendChild(s));const i=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceTransportPolicy:"all",bundlePolicy:"balanced",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});S.current[e.name]=i,i.ontrack=t=>{console.log(`Track received for stream ${e.name}:`,t),"video"===t.track.kind&&(o.srcObject=t.streams[0],o.onloadeddata=()=>{n&&(n.style.display="none")})},i.onicecandidate=t=>{t.candidate&&console.log(`ICE candidate for stream ${e.name}:`,t.candidate)},i.oniceconnectionstatechange=()=>{console.log(`ICE connection state for stream ${e.name}:`,i.iceConnectionState),"failed"!==i.iceConnectionState&&"disconnected"!==i.iceConnectionState||P(e.name,"WebRTC connection failed")},i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const l=setTimeout((()=>{console.warn(`WebRTC setup timed out for stream ${e.name}`),P(e.name,"WebRTC setup timed out"),S.current[e.name]&&W(e.name)}),15e3);i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((t=>(console.log(`Created offer for stream ${e.name}:`,t),console.log(`Original SDP for stream ${e.name}:`,t.sdp),t.sdp.includes("a=ice-ufrag:")&&t.sdp.includes("a=ice-pwd:")||console.warn(`SDP for stream ${e.name} is missing ice-ufrag or ice-pwd!`),console.log(`Using original offer for stream ${e.name}`),i.setLocalDescription(t)))).then((()=>(console.log(`Set local description for stream ${e.name}`),R(e.name,i.localDescription)))).then((t=>(console.log(`Received answer for stream ${e.name}:`,t),i.setRemoteDescription(new RTCSessionDescription(t))))).then((()=>{console.log(`Set remote description for stream ${e.name}`),clearTimeout(l),console.log(`Stream ${e.name} detection settings:`,{detection_based_recording:e.detection_based_recording,detection_model:e.detection_model,detection_threshold:e.detection_threshold}),e.detection_based_recording&&e.detection_model?(console.log(`Starting detection polling for stream ${e.name}`),d(e.name,s,o,$.current)):console.log(`Detection not enabled for stream ${e.name}`)})).catch((t=>{clearTimeout(l),console.error(`Error setting up WebRTC for stream ${e.name}:`,t),P(e.name,t.message)}))},R=async(e,t)=>{try{const a=localStorage.getItem("auth"),s={type:t.type,sdp:t.sdp};console.log(`Sending formatted offer for stream ${e}:`,s);const i=new AbortController,l=i.signal,c=setTimeout((()=>{console.warn(`Aborting WebRTC offer request for stream ${e} due to timeout`),i.abort()}),8e3);try{const t=await fetch(`/api/webrtc?src=${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:"Basic "+a}:{}},body:JSON.stringify(s),signal:l});if(clearTimeout(c),!t.ok)throw new Error(`Failed to send offer: ${t.status} ${t.statusText}`);const n=new AbortController,i=(n.signal,setTimeout((()=>{console.warn(`Aborting JSON parsing for stream ${e} due to timeout`),n.abort()}),5e3));try{const r=await t.text();clearTimeout(i);try{return JSON.parse(r)}catch(o){throw console.error(`Error parsing JSON for stream ${e}:`,o),console.log(`Raw response text: ${r}`),new Error(`Failed to parse WebRTC answer: ${o.message}`)}}catch(r){if(clearTimeout(i),"AbortError"===r.name)throw new Error(`WebRTC answer parsing timed out for stream ${e}`);throw r}}catch(n){if(clearTimeout(c),"AbortError"===n.name)throw new Error(`WebRTC offer request timed out for stream ${e}`);throw n}}catch(a){throw console.error(`Error sending offer for stream ${e}:`,a),a}},P=(e,t)=>{console.error(`WebRTC error for stream ${e}:`,t);const o=`video-${e.replace(/\s+/g,"-")}`,r=document.getElementById(o);if(!r)return;const n=r.closest(".video-cell");if(!n)return;const a=n.querySelector(".loading-indicator");a&&(a.style.display="none");let s=n.querySelector(".error-indicator");s||(s=document.createElement("div"),s.className="error-indicator",s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.display="flex",s.style.flexDirection="column",s.style.justifyContent="center",s.style.alignItems="center",s.style.backgroundColor="rgba(0, 0, 0, 0.7)",s.style.color="white",s.style.zIndex="20",n.appendChild(s)),s.innerHTML=`\n      <div className="error-icon">!</div>\n      <p>${t||"WebRTC connection failed"}</p>\n      <button className="retry-button mt-4 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Retry</button>\n    `,s.style.display="flex",s.style.pointerEvents="auto";const i=s.querySelector(".retry-button");i&&(i.style.position="relative",i.style.zIndex="30",i.style.pointerEvents="auto",i.addEventListener("click",(()=>{a&&(a.style.display="flex"),s.style.display="none",W(e),fetch(`/api/streams/${encodeURIComponent(e)}`).then((e=>e.json())).then((e=>{E(e)})).catch((e=>{console.error("Error fetching stream info:",e),s.style.display="flex";const t=s.querySelector("p");t&&(t.textContent="Could not reconnect: "+e.message),a&&(a.style.display="none")}))})))},W=e=>{S.current[e]&&(S.current[e].close(),delete S.current[e]);const t=`video-${e.replace(/\s+/g,"-")}`,o=document.getElementById(t);o&&(o.srcObject=null),m(e,$.current)},j=()=>{Object.keys(S.current).forEach((e=>{W(e)}))};return a("section",{id:"live-page",className:"page "+(g?"fullscreen-mode":""),children:[a("div",{className:"page-header flex justify-between items-center mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow",children:[a("div",{className:"flex items-center space-x-2",children:[a("h2",{className:"text-xl font-bold mr-4",children:"Live View"}),a("div",{className:"flex space-x-2",children:a("button",{id:"hls-toggle-btn",className:"px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800",onClick:()=>window.location.href="/hls.html",children:"HLS View"})})]}),a("div",{className:"controls flex items-center space-x-2",children:[a("div",{className:"flex items-center",children:[a("label",{for:"layout-selector",className:"mr-2",children:"Layout:"}),a("select",{id:"layout-selector",className:"px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600",value:s,onChange:e=>{const t=e.target.value;i(t),C(0)},children:[a("option",{value:"1",children:"1 Stream"}),a("option",{value:"2",children:"2 Streams"}),a("option",{value:"4",selected:!0,children:"4 Streams"}),a("option",{value:"6",children:"6 Streams"}),a("option",{value:"9",children:"9 Streams"}),a("option",{value:"16",children:"16 Streams"})]})]}),"1"===s&&a("div",{className:"flex items-center",children:[a("label",{for:"stream-selector",className:"mr-2",children:"Stream:"}),a("select",{id:"stream-selector",className:"px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600",value:l,onChange:e=>{const t=e.target.value;c(t)},children:e.map((e=>a("option",{value:e.name,children:e.name},e.name)))})]}),a("button",{id:"fullscreen-btn",className:"p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 focus:outline-none",onClick:()=>u(g,p),title:"Toggle Fullscreen",children:a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",children:a("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})]})]}),a("div",{className:"flex flex-col space-y-4",children:[a("div",{id:"video-grid",className:`video-container layout-${s}`,ref:T,children:w?a("div",{className:"flex justify-center items-center col-span-full row-span-full h-64 w-full",children:a("div",{className:"flex flex-col items-center justify-center py-8",children:[a("div",{className:"inline-block animate-spin rounded-full border-4 border-gray-300 dark:border-gray-600 border-t-blue-600 dark:border-t-blue-500 w-16 h-16"}),a("p",{className:"mt-4 text-gray-700 dark:text-gray-300",children:"Loading streams..."})]})}):0===e.length?a("div",{className:"placeholder flex flex-col justify-center items-center col-span-full row-span-full bg-white dark:bg-gray-800 rounded-lg shadow-md text-center p-8",children:[a("p",{className:"mb-6 text-gray-600 dark:text-gray-300 text-lg",children:"No streams configured"}),a("a",{href:"streams.html",className:"btn-primary px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Configure Streams"})]}):null}),"1"!==s&&e.length>k()?a("div",{className:"pagination-controls flex justify-center items-center space-x-4 mt-4",children:[a("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>C(Math.max(0,x-1)),disabled:0===x,children:"Previous"}),a("span",{className:"text-gray-700 dark:text-gray-300",children:["Page ",x+1," of ",Math.ceil(e.length/k())]}),a("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>C(Math.min(Math.ceil(e.length/k())-1,x+1)),disabled:x>=Math.ceil(e.length/k())-1,children:"Next"})]}):null]})]})}function t(){const[t,r]=o(!1),[s,i]=o(!0);return n((()=>{!async function(){try{const e=await fetch("/api/settings");if(!e.ok)return console.error("Failed to fetch settings:",e.status,e.statusText),void i(!1);(await e.json()).webrtc_disabled?(console.log("WebRTC is disabled, using HLS view"),r(!0)):(console.log("WebRTC is enabled, using WebRTC view"),r(!1))}catch(e){console.error("Error checking WebRTC status:",e)}finally{i(!1)}}()}),[]),s?a("div",{className:"loading",children:"Loading..."}):a(c,{children:[a(p,{}),t?a(g,{isWebRTCDisabled:!0}):a(e,{}),a(w,{})]})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("main-content");e&&s(a(l,{client:i,children:a(t,{})}),e)}))}}}));
//# sourceMappingURL=index-legacy-CZstn9n5.js.map
