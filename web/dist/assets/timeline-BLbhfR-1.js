var J=Object.freeze,fe=Object.defineProperty;var _=(o,v)=>J(fe(o,"raw",{value:J(v||o.slice())}));import{d as H,y as z,A as j,e as Q,u as a,k as pe,E as Se,q as ye,Q as ve}from"./query-client-mfCUf3pQ.js";/* empty css               */import{h as R,c as V,H as be,F as Te}from"./Footer-BFueUtxh.js";import{L as xe}from"./LoadingIndicator-BENYUScW.js";function _e(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}var Y,G,K;function we(){const[o,v]=H(!1),[w,S]=H(1);z(()=>{const l=e.subscribe(f=>{v(f.isPlaying),S(f.zoomLevel)});return()=>l()},[]);const u=()=>{console.log("TimelineControls: togglePlayback called"),console.log("TimelineControls: Current state before toggle:",{isPlaying:o,currentTime:e.currentTime,currentSegmentIndex:e.currentSegmentIndex,segmentsCount:e.timelineSegments?e.timelineSegments.length:0}),o?h():N()},h=()=>{e.setState({isPlaying:!1});const l=document.querySelector("#video-player video");l&&l.pause()},N=()=>{if(!e.timelineSegments||e.timelineSegments.length===0){V("No recordings to play","warning");return}console.log("TimelineControls: resumePlayback called"),console.log("TimelineControls: Current state:",{segments:e.timelineSegments.length,currentSegmentIndex:e.currentSegmentIndex,currentTime:e.currentTime,selectedDate:e.selectedDate});let l=null,f=-1,T=0;if(e.currentTime!==null){console.log("TimelineControls: Using current time to find segment:",e.currentTime);for(let b=0;b<e.timelineSegments.length;b++){const I=e.timelineSegments[b];if(e.currentTime>=I.start_timestamp&&e.currentTime<=I.end_timestamp){l=I,f=b,T=e.currentTime-I.start_timestamp,console.log("TimelineControls: Found segment ".concat(b," containing current time, relative time: ").concat(T,"s"));break}}if(!l){let b=0,I=1/0;for(let t=0;t<e.timelineSegments.length;t++){const i=e.timelineSegments[t],r=(i.start_timestamp+i.end_timestamp)/2,n=Math.abs(e.currentTime-r);n<I&&(I=n,b=t)}l=e.timelineSegments[b],f=b,e.currentTime<l.start_timestamp,T=0,console.log("TimelineControls: Using closest segment ".concat(b,", relative time: ").concat(T,"s"))}}else e.currentSegmentIndex>=0&&e.currentSegmentIndex<e.timelineSegments.length?(f=e.currentSegmentIndex,l=e.timelineSegments[f],T=0,console.log("TimelineControls: Using current segment index ".concat(f))):(f=0,l=e.timelineSegments[0],T=0,console.log("TimelineControls: Falling back to first segment"));console.log("TimelineControls: Playing segment ".concat(f," (ID: ").concat(l.id,") at time ").concat(T,"s")),e.currentSegmentIndex=f,e.currentTime=l.start_timestamp+T,e.isPlaying=!0,e.directVideoControl=!0,e.setState({}),setTimeout(()=>{console.log("TimelineControls: Resetting directVideoControl flag"),e.directVideoControl=!1,e.setState({})},3e3);const m=document.querySelector("#video-player video");if(m){m.pause();const b=()=>{console.log("TimelineControls: Video metadata loaded, setting time to ".concat(T,"s"));try{console.log("TimelineControls: Video metadata",{duration:m.duration,width:m.videoWidth,height:m.videoHeight,segment:l.id,segmentDuration:l.end_timestamp-l.start_timestamp});const I=Math.max(0,Math.min(T,m.duration||0));m.currentTime=I,setTimeout(()=>{e.isPlaying&&(console.log("TimelineControls: Starting video playback"),m.play().then(()=>{console.log("TimelineControls: Video playback started successfully");const t=(r=1)=>{r>5||setTimeout(()=>{m.paused&&e.isPlaying&&(console.log("TimelineControls: Video paused unexpectedly (attempt ".concat(r,"), trying to resume")),m.play().catch(n=>{console.error("Error resuming video (attempt ".concat(r,"):"),n)}),t(r+1))},500*r)};t();const i=l.end_timestamp-l.start_timestamp;if(console.log("TimelineControls: Segment duration: ".concat(i,"s, video duration: ").concat(m.duration,"s")),m.duration<i-1){console.log("TimelineControls: Video duration is shorter than segment duration, will monitor playback");const r=setInterval(()=>{if(!e.isPlaying||!m){clearInterval(r);return}m.currentTime>m.duration-.5&&T+m.currentTime<i&&(console.log("TimelineControls: Reached end of video but not end of segment, restarting video"),m.currentTime=0,m.play().catch(n=>{console.error("Error restarting video:",n)}))},500)}}).catch(t=>{console.error("Error playing video:",t),V("Error playing video: "+t.message,"error")}))},100)}catch(I){console.error("TimelineControls: Error in handleMetadataLoaded:",I)}finally{m.removeEventListener("loadedmetadata",b)}};m.addEventListener("loadedmetadata",b),console.log("TimelineControls: Loading video from segment ".concat(l.id)),m.src="/api/recordings/play/".concat(l.id,"?t=").concat(Date.now()),m.load()}else console.error("TimelineControls: No video element found"),V("Error: Video player not found","error")},D=()=>{if(w<8){const l=w*2;e.setState({zoomLevel:l}),V("Zoomed in: ".concat(24/l," hours view"),"info")}},g=()=>{if(w>1){const l=w/2;e.setState({zoomLevel:l}),V("Zoomed out: ".concat(24/l," hours view"),"info")}};return R(K||(K=_(['\n    <div class="timeline-controls flex justify-between items-center mb-2">\n      <div class="flex items-center">\n        <button\n          id="play-button"\n          class="w-10 h-10 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-green-500 focus:ring-offset-1 transition-colors shadow-sm mr-2"\n          onClick=',"\n          title=",'\n        >\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            ','\n          </svg>\n        </button>\n        <span class="text-xs text-gray-600 dark:text-gray-300">Play from current position</span>\n      </div>\n\n      <div class="flex items-center gap-1">\n        <span class="text-xs text-gray-600 dark:text-gray-300 mr-1">Zoom:</span>\n        <button\n          id="zoom-out-button"\n          class="w-6 h-6 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors"\n          onClick=','\n          title="Zoom Out (Show more time)"\n          disabled=','\n        >\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />\n          </svg>\n        </button>\n        <button\n          id="zoom-in-button"\n          class="w-6 h-6 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors"\n          onClick=','\n          title="Zoom In (Show less time)"\n          disabled=','\n        >\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />\n          </svg>\n        </button>\n      </div>\n    </div>\n  '])),u,o?"Pause":"Play from current position",o?R(Y||(Y=_(['\n                <!-- Pause icon - two vertical bars -->\n                <rect x="6" y="6" width="4" height="12" rx="1" fill="white" />\n                <rect x="14" y="6" width="4" height="12" rx="1" fill="white" />\n              ']))):R(G||(G=_(['\n                <!-- Play icon - triangle -->\n                <path d="M8 5.14v14l11-7-11-7z" fill="white" />\n              ']))),g,w<=1,D,w>=8)}var ee,te,ne,re,ie,oe;function ke(){const[o,v]=H(0),[w,S]=H(24),[u,h]=H(1);z(()=>{const D=e.subscribe(g=>{console.log("TimelineRuler: State update received",{zoomLevel:g.zoomLevel,segmentsCount:g.timelineSegments?g.timelineSegments.length:0,currentTime:g.currentTime});const l=24/g.zoomLevel;let f=12;if(g.currentTime!==null){const m=new Date(g.currentTime*1e3);f=m.getHours()+m.getMinutes()/60+m.getSeconds()/3600}else if(g.timelineSegments&&g.timelineSegments.length>0){let m=24,b=0;g.timelineSegments.forEach(I=>{const t=new Date(I.start_timestamp*1e3),i=new Date(I.end_timestamp*1e3),r=t.getHours()+t.getMinutes()/60+t.getSeconds()/3600,n=i.getHours()+i.getMinutes()/60+i.getSeconds()/3600;m=Math.min(m,r),b=Math.max(b,n)}),f=(m+b)/2,console.log("TimelineRuler: Calculated center from segments",{earliestHour:m,latestHour:b,centerHour:f})}let T=Math.max(0,f-l/2),P=Math.min(24,T+l);P===24&&l<24?(T=Math.max(0,24-l),P=24):T===0&&l<24&&(P=Math.min(24,l)),v(T),S(P),h(g.zoomLevel),console.log("TimelineRuler: Calculated time range",{newStartHour:T,newEndHour:P,hoursPerView:l,centerHour:f}),(e.timelineStartHour!==T||e.timelineEndHour!==P)&&(console.log("TimelineRuler: Updating global state with new time range"),e.setState({timelineStartHour:T,timelineEndHour:P}))});return()=>D()},[]);const N=()=>{const D=[];for(let g=Math.floor(o);g<=Math.ceil(w);g++)if(g>=0&&g<=24){const l=(g-o)/(w-o)*100;if(D.push(R(ee||(ee=_(['\n          <div\n            key="tick-','"\n            class="absolute top-0 w-px h-5 bg-gray-500 dark:bg-gray-400"\n            style="left: ','%;"\n          ></div>\n        '])),g,l)),D.push(R(te||(te=_(['\n          <div\n            key="label-','"\n            class="absolute top-0 text-xs text-gray-600 dark:text-gray-300 transform -translate-x-1/2"\n            style="left: ','%;"\n          >\n            ',":00\n          </div>\n        "])),g,l,g)),g<24&&u>=2){const f=(g+.5-o)/(w-o)*100;if(D.push(R(ne||(ne=_(['\n            <div\n              key="tick-','-30"\n              class="absolute top-2 w-px h-3 bg-gray-400 dark:bg-gray-500"\n              style="left: ','%;"\n            ></div>\n          '])),g,f)),u>=4){const T=(g+.25-o)/(w-o)*100,P=(g+.75-o)/(w-o)*100;D.push(R(re||(re=_(['\n              <div\n                key="tick-','-15"\n                class="absolute top-3 w-px h-2 bg-gray-400 dark:bg-gray-500"\n                style="left: ','%;"\n              ></div>\n            '])),g,T)),D.push(R(ie||(ie=_(['\n              <div\n                key="tick-','-45"\n                class="absolute top-3 w-px h-2 bg-gray-400 dark:bg-gray-500"\n                style="left: ','%;"\n              ></div>\n            '])),g,P))}}}return D};return R(oe||(oe=_(['\n    <div class="timeline-ruler relative w-full h-8 bg-gray-300 dark:bg-gray-800 border-b border-gray-400 dark:border-gray-600">\n      ','\n      <div class="absolute bottom-0 left-0 text-xs text-gray-500 px-1">\n        Zoom: ',"x ("," hours)\n      </div>\n    </div>\n  "])),N(),u,Math.round(24/u))}var se,le,ae,ce;function Ce({segments:o}){const[v,w]=H(o||[]),[S,u]=H(0),[h,N]=H(24),[D,g]=H(-1);z(()=>{console.log("TimelineSegments: Received segments from props: ".concat(o?o.length:0)),o&&o.length>0&&w(o)},[o]);const l=j(null),f=j(!1),T=j(0),P=j([]);z(()=>{const t=e.subscribe(i=>{console.log("TimelineSegments: State update received, segments: ".concat(i.timelineSegments?i.timelineSegments.length:0)),i.timelineSegments&&(!P.current||i.timelineSegments.length!==P.current.length||JSON.stringify(i.timelineSegments)!==JSON.stringify(P.current)||i.forceReload)&&(console.log("TimelineSegments: Updating segments (".concat(i.timelineSegments.length,")")),w(i.timelineSegments),P.current=[...i.timelineSegments],T.current=Date.now());const r=i.timelineStartHour!==void 0?i.timelineStartHour:0,n=i.timelineEndHour!==void 0?i.timelineEndHour:24;console.log("TimelineSegments: Time range update - startHour: ".concat(r,", endHour: ").concat(n)),u(r),N(n),g(i.currentSegmentIndex||-1)});return e.timelineSegments&&e.timelineSegments.length>0&&(console.log("TimelineSegments: Initial load of segments (".concat(e.timelineSegments.length,")")),w(e.timelineSegments),P.current=[...e.timelineSegments],g(e.currentSegmentIndex||0),e.timelineStartHour!==void 0&&u(e.timelineStartHour),e.timelineEndHour!==void 0&&N(e.timelineEndHour),T.current=Date.now()),()=>t()},[]),z(()=>{const t=l.current;if(!t)return;const i=d=>{(d.target===t||d.target.classList.contains("timeline-clickable-area"))&&(f.current=!0,m(d),document.addEventListener("mousemove",r),document.addEventListener("mouseup",n))},r=d=>{f.current&&m(d)},n=()=>{f.current=!1,document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};return t.addEventListener("mousedown",i),()=>{t.removeEventListener("mousedown",i),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)}},[S,h,v]);const m=t=>{const i=l.current;if(!i)return;const r=i.getBoundingClientRect(),n=t.clientX-r.left,d=r.width,s=n/d,x=S+s*(h-S),c=new Date(e.selectedDate);c.setHours(Math.floor(x)),c.setMinutes(Math.floor(x%1*60)),c.setSeconds(Math.floor(x%1*60%1*60));const C=c.getTime()/1e3;e.setState({currentTime:C,prevCurrentTime:e.currentTime,isPlaying:!1});let E=!1;for(let L=0;L<v.length;L++){const p=v[L],y=p.local_start_timestamp||p.start_timestamp,$=p.local_end_timestamp||p.end_timestamp;if(C>=y&&C<=$){if(console.log("TimelineSegments: Found segment ".concat(L," containing timestamp")),e.setState({currentSegmentIndex:L}),t.target.classList.contains("timeline-segment")){const k=C-y;b(L,k)}E=!0;break}}E||e.setState({currentSegmentIndex:-1})},b=(t,i=null)=>{if(console.log("TimelineSegments: playSegment(".concat(t,", ").concat(i,")")),t<0||t>=v.length){console.warn("TimelineSegments: Invalid segment index: ".concat(t));return}const r=v[t],n=r.local_start_timestamp||r.start_timestamp,d=i!==null?n+i:n;e.setState({isPlaying:!1,currentSegmentIndex:-1}),document.body.offsetHeight,setTimeout(()=>{e.setState({currentSegmentIndex:t,currentTime:d,isPlaying:!0,forceReload:!0}),setTimeout(()=>{const s=document.querySelector("#video-player video");s&&(s.pause(),s.removeAttribute("src"),s.load(),s.src="/api/recordings/play/".concat(r.id,"?t=").concat(Date.now()),s.onloadedmetadata=()=>{const x=i!==null?i:0;s.currentTime=x,s.play().catch(c=>console.error("Error playing video:",c))})},50)},50)},I=()=>{if(console.log("TimelineSegments: renderSegments called"),console.log("TimelineSegments: segments:",v),console.log("TimelineSegments: startHour:",S,"endHour:",h),!v||v.length===0)return console.log("TimelineSegments: No segments to render"),R(se||(se=_(['<div class="text-center text-red-500 font-bold">No segments to display</div>'])));console.log("TimelineSegments: Rendering segments:",v.length);const t=[],i=new Map;console.log("TimelineSegments: Starting to process segments");let r=0,n=0;v.forEach((c,C)=>{const E=c.start_timestamp,L=c.end_timestamp,p=new Date(E*1e3),y=new Date(L*1e3),$=p.getHours()+p.getMinutes()/60+p.getSeconds()/3600,k=y.getHours()+y.getMinutes()/60+y.getSeconds()/3600;if(k<S||$>h){n++,C<5&&console.log("TimelineSegments: Skipping segment ".concat(C,", startHour=").concat($,", endHour=").concat(k,", visible range=").concat(S,"-").concat(h));return}r++;const M=Math.floor($),F=Math.min(Math.ceil(k),24);for(let U=M;U<F;U++)U>=S&&U<=h&&(i.has(U)||i.set(U,[]),i.get(U).push(C))});const d=[];let s=null;[...v].sort((c,C)=>c.start_timestamp-C.start_timestamp).forEach((c,C)=>{if(!s)s={...c,originalIndices:[C]};else{const E=c.start_timestamp,L=s.end_timestamp;E-L<=1?(s.end_timestamp=c.end_timestamp,s.originalIndices.push(C),c.has_detection&&(s.has_detection=!0)):(d.push(s),s={...c,originalIndices:[C]})}}),s&&d.push(s),d.forEach((c,C)=>{const E=c.start_timestamp,L=c.end_timestamp,p=new Date(E*1e3),y=new Date(L*1e3),$=p.getHours()+p.getMinutes()/60+p.getSeconds()/3600,k=y.getHours()+y.getMinutes()/60+y.getSeconds()/3600;if(k<S||$>h)return;const M=Math.max($,S),F=Math.min(k,h),U=(M-S)/(h-S)*100,B=(F-M)/(h-S)*100,q=Math.round(L-E),O="".concat(q,"s"),Z=p.toLocaleTimeString(),X=y.toLocaleTimeString();t.push(R(le||(le=_(['\n        <div\n          key="segment-','"\n          class="timeline-segment absolute rounded-sm transition-all duration-200 ','"\n          style="left: ',"%; width: ","%; height: ",'%; top: 50%; transform: translateY(-50%);"\n          title="'," - "," (",')"\n        ></div>\n      '])),C,c.has_detection?"bg-red-500":"bg-blue-500",U,B,80,Z,X,O))});for(let c=Math.floor(S);c<Math.ceil(h);c++)if(!i.has(c)){const C=(c-S)/(h-S)*100,E=100/(h-S);t.push(R(ae||(ae=_(['\n          <div\n            key="clickable-','"\n            class="timeline-clickable-area absolute h-full cursor-pointer"\n            style="left: ',"%; width: ",'%;"\n            data-hour=',"\n          ></div>\n        "])),c,C,E,c))}return console.log("TimelineSegments: Rendering complete. Total: ".concat(v.length,", Visible: ").concat(r,", Skipped: ").concat(n,", Final rendered: ").concat(t.length)),t};return R(ce||(ce=_(['\n    <div\n      class="timeline-segments relative w-full h-16 pt-2"\n      ref=',"\n    >\n      ","\n    </div>\n  "])),l,I())}var me;function $e(){const[o,v]=H(0),[w,S]=H(!1),[u,h]=H(0),[N,D]=H(24),[g,l]=H(null),[f,T]=H(!1),P=j(null);j(null);const m=j(0),I=j(((r,n)=>{let d;return function(...s){d&&clearTimeout(d),d=setTimeout(()=>{r.apply(this,s)},n)}})((r,n,d)=>{t(r,n,d)},100)).current;z(()=>{const r=e.subscribe(n=>{console.log("TimelineCursor: State update received",{currentTime:n.currentTime,startHour:n.timelineStartHour,endHour:n.timelineEndHour,segmentsCount:n.timelineSegments?n.timelineSegments.length:0,isDragging:f,userControllingCursor:n.userControllingCursor}),h(n.timelineStartHour||0),D(n.timelineEndHour||24),!f&&!n.userControllingCursor&&(l(n.currentTime),i(n.currentTime),I(n.currentTime,n.timelineStartHour||0,n.timelineEndHour||24))});return()=>r()},[f,I]),z(()=>{const r=P.current;if(!r)return;const n=x=>{x.preventDefault(),x.stopPropagation(),console.log("TimelineCursor: Mouse down event"),m.current=x.clientX,T(!0),e.userControllingCursor=!0,e.setState({}),document.addEventListener("mousemove",d),document.addEventListener("mouseup",s)},d=x=>{if(!f)return;const c=r.parentElement;if(!c)return;const C=c.getBoundingClientRect(),E=Math.max(0,Math.min(x.clientX-C.left,C.width)),L=C.width,p=E/L*100;v(p);const y=N-u,$=u+p/100*y,k=new Date;e.selectedDate&&k.setTime(new Date(e.selectedDate).getTime()),k.setHours(Math.floor($)),k.setMinutes(Math.floor($%1*60)),k.setSeconds(Math.floor($%1*60%1*60)),k.setMilliseconds(0);const M=k.getTime()/1e3;l(M),i(M)},s=x=>{if(!f)return;const c=r.parentElement;if(!c)return;const C=c.getBoundingClientRect(),E=Math.max(0,Math.min(x.clientX-C.left,C.width)),L=C.width,p=E/L*100;console.log("TimelineCursor: Mouse up at position",{positionPercent:p,clickX:E,containerWidth:L});const y=N-u,$=u+p/100*y;console.log("TimelineCursor: Calculated hour",{hour:$,startHour:u,endHour:N,hourRange:y});const k=new Date;e.selectedDate&&k.setTime(new Date(e.selectedDate).getTime()),k.setHours(Math.floor($)),k.setMinutes(Math.floor($%1*60)),k.setSeconds(Math.floor($%1*60%1*60)),k.setMilliseconds(0);const M=k.getTime()/1e3;console.log("TimelineCursor: Converted to timestamp",{timestamp:M,dateTime:k.toLocaleString(),selectedDate:e.selectedDate}),console.log("TimelineCursor: Mouse up event"),T(!1),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s),setTimeout(()=>{console.log("TimelineCursor: Releasing cursor control"),e.userControllingCursor=!1,e.setState({})},100),e.currentTime=M,e.prevCurrentTime=e.currentTime,e.isPlaying=!1,e.setState({});const F=e.timelineSegments||[];console.log("TimelineCursor: Searching for segment containing timestamp",{timestamp:M,segmentsCount:F.length});let U=!1,B=-1,q=1/0;for(let O=0;O<F.length;O++){const Z=F[O],X=Z.local_start_timestamp||Z.start_timestamp,A=Z.local_end_timestamp||Z.end_timestamp;if(O<3&&console.log("TimelineCursor: Segment ".concat(O),{startTimestamp:X,endTimestamp:A,startTime:new Date(X*1e3).toLocaleTimeString(),endTime:new Date(A*1e3).toLocaleTimeString()}),M>=X&&M<=A){console.log("TimelineCursor: Found exact match at segment ".concat(O)),e.currentSegmentIndex=O,e.setState({}),U=!0;break}const he=(X+A)/2,W=Math.abs(M-he);W<q&&(q=W,B=O)}U||(B>=0?(console.log("TimelineCursor: No exact match, using closest segment ".concat(B)),e.currentSegmentIndex=B,e.setState({})):(console.log("TimelineCursor: No segments found at all"),e.currentSegmentIndex=-1,e.setState({})))};return r.addEventListener("mousedown",n),()=>{r.removeEventListener("mousedown",n),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",s)}},[P.current,u,N,f]);const t=(r,n,d)=>{if(console.log("TimelineCursor: updateCursorPosition called",{time:r,startHr:n,endHr:d}),r===null){console.log("TimelineCursor: No current time, hiding cursor"),S(!1);return}const s=new Date(r*1e3),x=s.getHours()+s.getMinutes()/60+s.getSeconds()/3600;if(console.log("TimelineCursor: Calculated hour",{hour:x,timeString:s.toLocaleTimeString()}),x<n||x>d){console.log("TimelineCursor: Time outside visible range, hiding cursor"),S(!1);return}const c=(x-n)/(d-n)*100;console.log("TimelineCursor: Calculated position",{position:c,hour:x,startHr:n,endHr:d}),v(c),S(!0)},i=r=>{if(r===null)return;const n=document.getElementById("time-display");if(!n)return;const d=new Date(r*1e3),s=d.getHours().toString().padStart(2,"0"),x=d.getMinutes().toString().padStart(2,"0"),c=d.getSeconds().toString().padStart(2,"0");n.textContent="".concat(s,":").concat(x,":").concat(c)};return z(()=>{console.log("TimelineCursor: Initializing cursor position"),console.log("TimelineCursor: Initial state",{currentTime:e.currentTime,startHour:e.timelineStartHour,endHour:e.timelineEndHour,segments:e.timelineSegments?e.timelineSegments.length:0});const r=()=>{if(console.log("TimelineCursor: Checking timelineState directly",{currentTime:e.currentTime,segmentsLength:e.timelineSegments?e.timelineSegments.length:0,currentSegmentIndex:e.currentSegmentIndex}),e.currentTime)return console.log("TimelineCursor: Setting initial cursor position with current time"),S(!0),t(e.currentTime,e.timelineStartHour||0,e.timelineEndHour||24),!0;if(e.timelineSegments&&e.timelineSegments.length>0){console.log("TimelineCursor: Using first segment start time for cursor");const s=e.timelineSegments[0].start_timestamp;return console.log("TimelineCursor: Directly setting timelineState properties"),e.currentTime=s,e.currentSegmentIndex=0,e.setState({}),S(!0),t(s,e.timelineStartHour||0,e.timelineEndHour||24),!0}return!1};r()||(console.log("TimelineCursor: Initial initialization failed, will retry after delay"),[100,300,500,1e3].forEach((s,x)=>{setTimeout(()=>{w||(console.log("TimelineCursor: Retry initialization attempt ".concat(x+1)),r())},s)}))},[]),R(me||(me=_(["\n    <div\n      ref=",'\n      class="timeline-cursor absolute top-0 h-full z-50 transition-all duration-100 cursor-ew-resize"\n      style="left: ',"%; display: ",'; pointer-events: auto; width: 7px; margin-left: -3.5px;"\n    >\n      <!-- Invisible wider clickable area -->\n      <div class="absolute top-0 bottom-0 left-0 w-full"></div>\n\n      <!-- Skinnier needle with no middle chunk -->\n      <div class="absolute top-0 bottom-0 w-0.5 bg-orange-500 left-1/2 transform -translate-x-1/2 pointer-events-none"></div>\n\n      <!-- Top handle (black) -->\n      <div class="absolute top-0 left-1/2 w-4 h-4 bg-black rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-md pointer-events-none"></div>\n\n      <!-- Bottom handle (black) -->\n      <div class="absolute bottom-0 left-1/2 w-4 h-4 bg-black rounded-full transform -translate-x-1/2 translate-y-1/2 shadow-md pointer-events-none"></div>\n    </div>\n  '])),P,o,w?"block":"none")}var de,ge;function Pe(){const[o,v]=H(1),w=[.25,.5,1,1.5,2,4];z(()=>{const u=e.subscribe(h=>{v(h.playbackSpeed)});return()=>u()},[]);const S=u=>{const h=document.querySelector("#video-player video");h&&(h.playbackRate=u),e.setState({playbackSpeed:u}),V("Playback speed: ".concat(u,"x"),"info")};return R(ge||(ge=_(['\n    <div class="mt-2 mb-4 p-2 border border-green-500 rounded-lg bg-white dark:bg-gray-800 shadow-sm">\n      <div class="flex flex-col items-center">\n        <div class="text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300">Playback Speed</div>\n        \n        <div class="flex flex-wrap justify-center gap-1">\n          ','\n        </div>\n        \n        <div class="mt-1 text-xs font-medium text-green-600 dark:text-green-400">\n          Current: ',"× ","\n        </div>\n      </div>\n    </div>\n  "])),w.map(u=>R(de||(de=_(["\n            <button \n              key=","\n              class=","\n              data-speed=","\n              onClick=","\n            >\n              ","\n            </button>\n          "])),"speed-".concat(u),"speed-btn px-2 py-1 text-sm rounded-full ".concat(u===o?"bg-green-500 text-white":"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"," \n                font-medium transition-all focus:outline-none focus:ring-1 focus:ring-green-500 focus:ring-opacity-50"),u,()=>S(u),u===1?"1× (Normal)":"".concat(u,"×"))),o,o===1?"(Normal)":"")}var ue;function He(){const[o,v]=H(-1),[w,S]=H(!1),[u,h]=H([]),[N,D]=H(1),g=j(null),l=j(null),f=j(null);z(()=>{const t=e.subscribe(i=>{v(i.currentSegmentIndex),S(i.isPlaying),h(i.timelineSegments||[]),D(i.playbackSpeed),T(i)});return()=>t()},[]);const T=t=>{const i=g.current;if(!i||!t.timelineSegments||t.timelineSegments.length===0||t.currentSegmentIndex<0||t.currentSegmentIndex>=t.timelineSegments.length)return;const r=t.timelineSegments[t.currentSegmentIndex];if(!r)return;const n=f.current!==r.id,d=n,s=t.currentTime!==null&&t.currentTime>=r.start_timestamp?t.currentTime-r.start_timestamp:0,x=t.prevCurrentTime!==null&&Math.abs(t.currentTime-t.prevCurrentTime)>1;n&&(console.log("Segment changed from ".concat(f.current," to ").concat(r.id)),f.current=r.id),d?(console.log("Loading new segment ".concat(r.id," (segmentChanged: ").concat(n,")")),P(r,s,t.isPlaying)):x?(console.log("Seeking to ".concat(s,"s within current segment")),i.currentTime=s):t.isPlaying&&i.paused?i.play().catch(c=>{console.error("Error playing video:",c)}):!t.isPlaying&&!i.paused&&i.pause(),i.playbackRate!==t.playbackSpeed&&(i.playbackRate=t.playbackSpeed)},P=(t,i=0,r=!1)=>{const n=g.current;if(!n)return;console.log("Loading segment ".concat(t.id," at time ").concat(i,"s, autoplay: ").concat(r)),n.pause();const d="/api/recordings/play/".concat(t.id,"?t=").concat(Date.now()),s=()=>{console.log("Video metadata loaded"),n.currentTime=i,n.playbackRate=N,r&&n.play().catch(x=>{console.error("Error playing video:",x),V("Error playing video: "+x.message,"error")}),n.removeEventListener("loadedmetadata",s)};n.addEventListener("loadedmetadata",s),n.src=d,n.load()},m=()=>{if(console.log("Video ended"),o<u.length-1){const t=o+1;console.log("Playing next segment ".concat(t)),e.setState({currentSegmentIndex:t,currentTime:u[t].start_timestamp,isPlaying:!0,forceReload:!0})}else console.log("End of all segments"),e.setState({isPlaying:!1})},b=()=>{const t=g.current;if(!t||o<0||!u||u.length===0||o>=u.length)return;const i=u[o];if(!i)return;const r=i.start_timestamp+t.currentTime;I(r),e.setState({currentTime:r,prevCurrentTime:l.current}),l.current=r},I=t=>{if(t===null)return;const i=document.getElementById("time-display");if(!i)return;const r=new Date(t*1e3),n=r.getHours().toString().padStart(2,"0"),d=r.getMinutes().toString().padStart(2,"0"),s=r.getSeconds().toString().padStart(2,"0");i.textContent="".concat(n,":").concat(d,":").concat(s)};return R(ue||(ue=_(['\n    <div class="timeline-player-container mb-2" id="video-player">\n      <div class="relative w-full bg-black rounded-lg shadow-md" style="aspect-ratio: 16/9;">\n        <video\n            ref=','\n            class="w-full h-full object-contain"\n            controls\n            autoplay=',"\n            muted=","\n            playsInline\n            onended=","\n            ontimeupdate=",'\n        ></video>\n        \n        <!-- Add a message for invalid segments -->\n        <div \n          class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-white text-center p-4 ','"\n        >\n          <div>\n            <p class="mb-2">No valid segment selected.</p>\n            <p class="text-sm">Click on a segment in the timeline or use the play button to start playback.</p>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- Playback speed controls -->\n    <'," />\n  "])),g,!1,!1,m,b,o>=0&&u.length>0?"hidden":"",Pe)}const e={streams:[],timelineSegments:[],selectedStream:null,selectedDate:null,isPlaying:!1,currentSegmentIndex:-1,zoomLevel:1,timelineStartHour:0,timelineEndHour:24,currentTime:null,prevCurrentTime:null,playbackSpeed:1,showOnlySegments:!0,forceReload:!1,userControllingCursor:!1,listeners:new Set,lastUpdateTime:0,pendingUpdates:{},setState(o){const v=Date.now();if(console.log("timelineState: setState called with",o),console.log("timelineState: current state before update",{currentTime:this.currentTime,currentSegmentIndex:this.currentSegmentIndex,segmentsLength:this.timelineSegments.length}),o.currentTime!==void 0&&!o.currentSegmentIndex&&!o.isPlaying&&v-this.lastUpdateTime<250){console.log("timelineState: Skipping frequent time update");return}Object.assign(this,o),o.forceReload&&(this.forceReload=!1),this.lastUpdateTime=v,console.log("timelineState: state after update",{currentTime:this.currentTime,currentSegmentIndex:this.currentSegmentIndex,segmentsLength:this.timelineSegments.length}),this.notifyListeners()},subscribe(o){return this.listeners.add(o),()=>this.listeners.delete(o)},notifyListeners(){this.listeners.forEach(o=>o(this))},flushPendingUpdates(){Object.keys(this.pendingUpdates).length>0&&(Object.assign(this,this.pendingUpdates),this.pendingUpdates={},this.lastUpdateTime=Date.now(),this.notifyListeners())}};function De(o){const v=o.getFullYear(),w=String(o.getMonth()+1).padStart(2,"0"),S=String(o.getDate()).padStart(2,"0");return"".concat(v,"-").concat(w,"-").concat(S)}function Ie(){const o=new URLSearchParams(window.location.search);return{stream:o.get("stream")||"",date:o.get("date")||De(new Date)}}function Le(o,v){if(!o)return;const w=new URL(window.location.href);w.searchParams.set("stream",o),w.searchParams.set("date",v),window.history.replaceState({},"",w)}function Ee(){const o=Ie(),[v,w]=H(!1),[S,u]=H([]),[h,N]=H(o.stream),[D,g]=H(o.date),[l,f]=H([]),T=j(null),P=j(!1),m=j(null);z(()=>(m.current=setInterval(()=>{e.flushPendingUpdates()},200),()=>{m.current&&clearInterval(m.current)}),[]);const{data:b,isLoading:I,error:t}=Q("streams","/api/streams",{timeout:15e3,retries:2,retryDelay:1e3});z(()=>{if(b&&Array.isArray(b)&&b.length>0&&!P.current){if(console.log("TimelinePage: Streams loaded, initializing data"),P.current=!0,u(b),e.setState({streams:b}),b.some(y=>y.name===h)&&h)console.log("TimelinePage: Using stream from URL: ".concat(h));else if(b.length>0){const y=b[0].name;console.log("TimelinePage: Using first stream: ".concat(y)),N(y)}}},[b]),z(()=>{t&&(console.error("TimelinePage: Error loading streams:",t),V("Error loading streams: "+t.message,"error"))},[t]);const i=p=>{const y=new Date(p);y.setHours(0,0,0,0);const $=new Date(p);return $.setHours(23,59,59,999),{startTime:y.toISOString(),endTime:$.toISOString()}};z(()=>{h&&(Le(h,D),e.setState({selectedStream:h,selectedDate:D}))},[h,D]);const{startTime:r,endTime:n}=i(D),{data:d,isLoading:s,error:x,refetch:c}=Q(["timeline-segments",h,D],h?"/api/timeline/segments?stream=".concat(encodeURIComponent(h),"&start=").concat(encodeURIComponent(r),"&end=").concat(encodeURIComponent(n)):null,{timeout:3e4,retries:2,retryDelay:1e3},{enabled:!!h,onSuccess:p=>{console.log("TimelinePage: Timeline data received:",p);const y=p.segments||[];if(console.log("TimelinePage: Received ".concat(y.length," segments")),y.length===0){console.log("TimelinePage: No segments found"),f([]),e.setState({timelineSegments:[],currentSegmentIndex:-1,currentTime:null,isPlaying:!1}),V("No recordings found for the selected date","warning");return}const $=JSON.parse(JSON.stringify(y));$.slice(0,3).forEach((F,U)=>{const B=new Date(F.start_timestamp*1e3),q=new Date(F.end_timestamp*1e3);console.log("TimelinePage: Segment ".concat(U," - Start: ").concat(B.toLocaleTimeString(),", End: ").concat(q.toLocaleTimeString()))}),console.log("TimelinePage: Setting segments"),f($),document.body.offsetHeight;const k=$[0].start_timestamp;console.log("TimelinePage: Setting initial segment and time",{firstSegmentId:$[0].id,startTime:new Date(k*1e3).toLocaleTimeString()}),console.log("TimelinePage: Directly setting timelineState properties"),e.timelineSegments=$,e.currentSegmentIndex=0,e.currentTime=k,e.prevCurrentTime=k,e.isPlaying=!1,e.forceReload=!0,e.zoomLevel=1,e.selectedDate=D,e.setState({}),console.log("TimelinePage: Updated timelineState with segments"),setTimeout(()=>{console.log("TimelinePage: State after update (delayed check):",{segmentsLength:e.timelineSegments.length,currentSegmentIndex:e.currentSegmentIndex,currentTime:e.currentTime}),(!e.currentTime||e.currentSegmentIndex===-1)&&(console.log("TimelinePage: State not properly updated, forcing update"),e.setState({currentSegmentIndex:0,currentTime:k,prevCurrentTime:k}))},100);const M=document.querySelector("#video-player video");M&&(M.src="/api/recordings/play/".concat($[0].id,"?t=").concat(Date.now()),M.load()),V("Loaded ".concat($.length," recording segments"),"success")},onError:p=>{console.error("TimelinePage: Error loading timeline data:",p),V("Error loading timeline data: "+p.message,"error"),f([])}}),C=p=>{const y=p.target.value;console.log("TimelinePage: Stream changed to ".concat(y)),N(y)},E=p=>{const y=p.target.value;console.log("TimelinePage: Date changed to ".concat(y)),g(y)},L=()=>s?a(xe,{message:"Loading timeline data..."}):l.length===0?a("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[a("svg",{className:"w-16 h-16 text-gray-400 dark:text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:a("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),a("p",{className:"text-gray-600 dark:text-gray-400 text-lg",children:"No recordings found for the selected date and stream"})]}):a(pe,{children:[a(He,{}),a(we,{}),a("div",{id:"timeline-container",className:"relative w-full h-24 bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg mb-6 overflow-hidden",ref:T,children:[a(ke,{}),a(Ce,{segments:l}),a($e,{}),a("div",{className:"absolute bottom-1 right-2 text-xs text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 bg-opacity-75 dark:bg-opacity-75 px-2 py-1 rounded",children:"Drag the orange dial to navigate"})]})]});return a("div",{className:"timeline-page",children:[a("div",{className:"flex items-center mb-4",children:[a("h1",{className:"text-2xl font-bold",children:"Timeline Playback"}),a("div",{className:"ml-4 flex",children:[a("a",{href:"recordings.html",className:"px-3 py-1 bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-l-md",children:"Table View"}),a("a",{href:"timeline.html",className:"px-3 py-1 bg-blue-500 text-white rounded-r-md",children:"Timeline View"})]})]}),a("div",{className:"flex flex-wrap gap-4 mb-2",children:[a("div",{className:"stream-selector flex-grow",children:[a("div",{className:"flex justify-between items-center mb-2",children:[a("label",{htmlFor:"stream-selector",children:"Stream"}),a("button",{className:"text-xs bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-2 py-1 rounded",onClick:()=>c(),children:"Reload Data"})]}),a("select",{id:"stream-selector",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white",value:h||"",onChange:C,children:[a("option",{value:"",disabled:!0,children:["Select a stream (",S.length," available)"]}),S.map(p=>a("option",{value:p.name,children:p.name},p.name))]})]}),a("div",{className:"date-selector flex-grow",children:[a("label",{htmlFor:"timeline-date",className:"block mb-2",children:"Date"}),a("input",{type:"date",id:"timeline-date",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white",value:D,onChange:E})]})]}),a("div",{className:"mb-4 text-sm text-gray-500 dark:text-gray-400 italic",children:s?"Loading...":"Recordings auto-load when stream or date changes"}),a("div",{className:"flex justify-between items-center mb-2",children:a("div",{id:"time-display",className:"timeline-time-display bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded font-mono text-base",children:"00:00:00"})}),a("div",{className:"mb-2 text-xs text-gray-500",children:["Debug - isLoading: ",s?"true":"false",", Streams: ",S.length,", Segments: ",l.length]}),L(),a("div",{className:"mt-6 p-4 bg-gray-200 dark:bg-gray-800 rounded",children:[a("h3",{className:"text-lg font-semibold mb-2",children:"How to use the timeline:"}),a("ul",{className:"list-disc pl-5",children:[a("li",{children:"Select a stream and date to load recordings"}),a("li",{children:"Click on the timeline to position the cursor at a specific time"}),a("li",{children:"Drag the orange cursor to navigate precisely"}),a("li",{children:"Click on a segment (blue bar) to play that recording"}),a("li",{children:"Use the play button to start playback from the current cursor position"}),a("li",{children:"Use the zoom buttons to adjust the timeline scale"})]})]})]})}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("main-content");o&&Se(a(ve,{client:ye,children:[a(be,{}),a(Ee,{}),a(Te,{})]}),o)});export{_e as __vite_legacy_guard};
//# sourceMappingURL=timeline-BLbhfR-1.js.map
