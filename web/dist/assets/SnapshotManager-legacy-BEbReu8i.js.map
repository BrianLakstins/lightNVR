{"version":3,"file":"SnapshotManager-legacy-BEbReu8i.js","sources":["../../js/components/preact/SnapshotManager.jsx"],"sourcesContent":["/**\n * Snapshot functionality for LiveView\n * React component for managing snapshots\n */\nimport { h } from 'preact';\nimport { useState, useCallback, useEffect } from 'preact/hooks';\nimport { showStatusMessage } from './ToastContainer.jsx';\nimport { showSnapshotPreview } from './UI.jsx';\n\n/**\n * Custom hook for snapshot functionality\n * @returns {Object} Snapshot functions and state\n */\nexport function useSnapshotManager() {\n  const [snapshotData, setSnapshotData] = useState({\n    canvas: null,\n    fileName: null\n  });\n\n  /**\n   * Take a snapshot of a stream\n   * @param {string} streamId - ID of the stream\n   * @param {Event} event - Optional click event\n   */\n  const takeSnapshot = useCallback((streamId, event) => {\n    console.log(`Taking snapshot of stream with ID: ${streamId}`);\n\n    // Find the stream by ID or name\n    const streamElement = document.querySelector(`.snapshot-btn[data-id=\"${streamId}\"]`);\n    let streamName;\n\n    if (streamElement) {\n      // Get the stream name from the data attribute\n      streamName = streamElement.getAttribute('data-name');\n    } else if (event) {\n      // If we can't find by data-id, try to find from the event target\n      const clickedButton = event.currentTarget || event.target;\n      const videoCell = clickedButton ? clickedButton.closest('.video-cell') : null;\n\n      if (videoCell) {\n        streamName = videoCell.dataset.streamName;\n      }\n    }\n\n    if (!streamName) {\n      console.error('Stream name not found for ID:', streamId);\n      showStatusMessage('Cannot take snapshot: Stream not identified', 'error');\n      return;\n    }\n\n    // Find the video element\n    const videoElementId = `video-${streamName.replace(/\\s+/g, '-')}`;\n    const videoElement = document.getElementById(videoElementId);\n    if (!videoElement) {\n      console.error('Video element not found for stream:', streamName);\n      return;\n    }\n\n    // Create a canvas element to capture the frame\n    const canvas = document.createElement('canvas');\n    canvas.width = videoElement.videoWidth;\n    canvas.height = videoElement.videoHeight;\n\n    // Check if we have valid dimensions\n    if (canvas.width === 0 || canvas.height === 0) {\n      console.error('Invalid video dimensions:', canvas.width, canvas.height);\n      showStatusMessage('Cannot take snapshot: Video not loaded or has invalid dimensions');\n      return;\n    }\n\n    // Draw the current frame to the canvas\n    const ctx = canvas.getContext('2d');\n    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);\n\n    try {\n      // Generate a filename\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n      const fileName = `snapshot-${streamName.replace(/\\s+/g, '-')}-${timestamp}.jpg`;\n      \n      // Store the canvas and filename in state\n      setSnapshotData({\n        canvas,\n        fileName\n      });\n\n      // Show the standard preview\n      showSnapshotPreview(canvas.toDataURL('image/jpeg', 0.95), `Snapshot: ${streamName}`);\n\n      // Show success message\n      showStatusMessage('Snapshot taken successfully');\n    } catch (error) {\n      console.error('Error creating snapshot:', error);\n      showStatusMessage('Failed to create snapshot: ' + error.message);\n    }\n  }, []);\n\n  /**\n   * Download the snapshot as JPEG\n   */\n  const downloadSnapshot = useCallback(() => {\n    const { canvas, fileName } = snapshotData;\n    \n    if (!canvas) {\n      console.error('No snapshot canvas available');\n      showStatusMessage('Download failed: No snapshot data available');\n      return;\n    }\n\n    // Convert canvas to blob and download\n    canvas.toBlob(function(blob) {\n      if (!blob) {\n        console.error('Failed to create blob from canvas');\n        showStatusMessage('Download failed: Unable to create image data');\n        return;\n      }\n\n      console.log('Created blob:', blob.size, 'bytes');\n\n      // Create object URL from blob\n      const blobUrl = URL.createObjectURL(blob);\n      console.log('Created blob URL:', blobUrl);\n\n      // Create download link\n      const link = document.createElement('a');\n      link.href = blobUrl;\n      link.download = fileName || 'snapshot.jpg';\n\n      // Add the link to the document\n      document.body.appendChild(link);\n      console.log('Added download link to document');\n\n      // Trigger click\n      link.click();\n\n      // Clean up\n      setTimeout(() => {\n        if (document.body.contains(link)) {\n          document.body.removeChild(link);\n        }\n        URL.revokeObjectURL(blobUrl);\n        console.log('Cleaned up download resources');\n      }, 1000);\n\n      showStatusMessage('Download started');\n    }, 'image/jpeg', 0.95); // High quality JPEG\n  }, [snapshotData]);\n\n  return {\n    takeSnapshot,\n    downloadSnapshot,\n    hasSnapshot: !!snapshotData.canvas\n  };\n}\n\n/**\n * SnapshotManager component\n * @returns {JSX.Element} SnapshotManager component\n */\nexport function SnapshotManager() {\n  const { takeSnapshot, downloadSnapshot } = useSnapshotManager();\n  \n  // Register the takeSnapshot function globally for backward compatibility\n  useEffect(() => {\n    window.takeSnapshot = takeSnapshot;\n    \n    return () => {\n      // Clean up global function when component unmounts\n      delete window.takeSnapshot;\n    };\n  }, [takeSnapshot]);\n\n  // This component doesn't render anything visible\n  return null;\n}\n\n/**\n * SnapshotButton component\n * @param {Object} props Component props\n * @param {string} props.streamId Stream ID\n * @param {string} props.streamName Stream name\n * @returns {JSX.Element} SnapshotButton component\n */\nexport function SnapshotButton({ streamId, streamName }) {\n  const { takeSnapshot } = useSnapshotManager();\n  \n  const handleClick = (event) => {\n    event.preventDefault();\n    event.stopPropagation();\n    takeSnapshot(streamId, event);\n  };\n  \n  return (\n    <button \n      className=\"snapshot-btn\" \n      title=\"Take Snapshot\" \n      data-id={streamId} \n      data-name={streamName}\n      onClick={handleClick}\n    >\n      <svg \n        xmlns=\"http://www.w3.org/2000/svg\" \n        width=\"24\" \n        height=\"24\" \n        viewBox=\"0 0 24 24\" \n        fill=\"none\" \n        stroke=\"white\" \n        stroke-width=\"2\" \n        stroke-linecap=\"round\" \n        stroke-linejoin=\"round\"\n      >\n        <path d=\"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z\"></path>\n        <circle cx=\"12\" cy=\"13\" r=\"4\"></circle>\n      </svg>\n    </button>\n  );\n}\n\n/**\n * DownloadButton component\n * @param {Object} props Component props\n * @returns {JSX.Element} DownloadButton component\n */\nexport function DownloadButton() {\n  const { downloadSnapshot, hasSnapshot } = useSnapshotManager();\n  \n  if (!hasSnapshot) return null;\n  \n  return (\n    <button \n      className=\"download-btn px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors\"\n      onClick={downloadSnapshot}\n    >\n      Download\n    </button>\n  );\n}\n"],"names":["useSnapshotManager","snapshotData","setSnapshotData","useState","canvas","fileName","takeSnapshot","useCallback","streamId","event","console","log","streamElement","document","querySelector","streamName","getAttribute","clickedButton","currentTarget","target","videoCell","closest","dataset","error","showStatusMessage","videoElementId","replace","videoElement","getElementById","createElement","width","videoWidth","height","videoHeight","getContext","drawImage","timestamp","Date","toISOString","showSnapshotPreview","toDataURL","message","downloadSnapshot","toBlob","blob","size","blobUrl","URL","createObjectURL","link","href","download","body","appendChild","click","setTimeout","contains","removeChild","revokeObjectURL","hasSnapshot","jsx","className","title","onClick","preventDefault","stopPropagation","children","jsxs","xmlns","viewBox","fill","stroke","d","cx","cy","r","useEffect","window"],"mappings":"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"}