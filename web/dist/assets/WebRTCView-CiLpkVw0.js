const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./preact-app-Cn527Soc.js","./preact-app-B50Zg-w-.css"])))=>i.map(i=>d[i]);
var F=Object.freeze,N=Object.defineProperty;var h=(d,b)=>F(N(d,"raw",{value:F(b||d.slice())}));import{d as E,A as P,y as _,h as w,_ as ee,s as te,a as oe,b as ne,c as y,e as re}from"./preact-app-Cn527Soc.js";import{t as se,e as ie,s as ce,c as le}from"./DetectionOverlay-CfeogdP4.js";var B,q,A,D,V,G;function ae(){const[d,b]=E([]),[g,U]=E("4"),[x,L]=E(""),[W,j]=E(!1),[J,T]=E(!0),[p,I]=E(0),$=P(null),f=P({}),O=P({});_(()=>{te(),oe(),ne();const e=o=>{if(o.key==="Escape"){console.log("Escape key pressed, current fullscreen state:",W);const t=document.getElementById("live-page");t&&t.classList.contains("fullscreen-mode")&&(console.log("Detected fullscreen mode via DOM, exiting fullscreen"),ie(null,j))}};document.addEventListener("keydown",e);const c=()=>{M()},i=()=>{document.hidden?(console.log("Page hidden, pausing WebRTC streams"),Object.keys(f.current).forEach(o=>{const t=f.current[o];if(t&&t.connectionState!=="closed"){const s="video-".concat(o.replace(/\s+/g,"-")),n=document.getElementById(s);n&&n.pause()}})):(console.log("Page visible, resuming WebRTC streams"),Object.keys(f.current).forEach(o=>{const t=f.current[o];if(t&&t.connectionState!=="closed"){const s="video-".concat(o.replace(/\s+/g,"-")),n=document.getElementById(s);n&&n.play().catch(u=>{console.warn("Could not resume video for ".concat(o,":"),u)})}}))};window.addEventListener("beforeunload",c),document.addEventListener("visibilitychange",i);const r=setInterval(()=>{Object.keys(f.current).forEach(o=>{const t=f.current[o];if(t&&(console.debug("WebRTC connection state for ".concat(o,": ").concat(t.connectionState,", ICE state: ").concat(t.iceConnectionState)),t.iceConnectionState==="failed"||t.iceConnectionState==="disconnected")){console.warn("WebRTC connection for ".concat(o," is in ").concat(t.iceConnectionState," state, will attempt reconnect")),S(o);const s=d.find(n=>n.name===o);s&&(console.log("Attempting to reconnect WebRTC for stream ".concat(o)),k(s))}})},3e4);return()=>{document.removeEventListener("keydown",e),window.removeEventListener("beforeunload",c),document.removeEventListener("visibilitychange",i),clearInterval(r),M()}},[d]),_(()=>{T(!0);const e=setTimeout(()=>{console.warn("Stream loading timed out"),T(!1),y("Loading streams timed out. Please try refreshing the page.")},15e3);z().then(c=>{clearTimeout(e),c&&c.length>0?(b(c),L(c[0].name)):console.warn("No streams returned from API"),T(!1)}).catch(c=>{clearTimeout(e),console.error("Error loading streams:",c),y("Error loading streams: "+c.message),T(!1)})},[]),_(()=>{K()},[g,x,d,p]);const z=async()=>{try{const e=new Promise((a,l)=>{setTimeout(()=>l(new Error("Request timed out")),5e3)}),c=fetch("/api/streams"),i=await Promise.race([c,e]);if(!i.ok)throw new Error("Failed to load streams");const r=new Promise((a,l)=>{setTimeout(()=>l(new Error("JSON parsing timed out")),3e3)}),o=i.json(),s=(await Promise.race([o,r])||[]).map(a=>{const l=new Promise((m,Z)=>{setTimeout(()=>Z(new Error("Timeout fetching details for stream ".concat(a.name))),3e3)}),v=fetch("/api/streams/".concat(encodeURIComponent(a.id||a.name))).then(m=>{if(!m.ok)throw new Error("Failed to load details for stream ".concat(a.name));return m.json()});return Promise.race([v,l]).catch(m=>(console.error("Error loading details for stream ".concat(a.name,":"),m),a))}),n=await Promise.all(s);console.log("Loaded detailed streams for WebRTC view:",n);const u=n.filter(a=>a.is_deleted?(console.log("Stream ".concat(a.name," is soft deleted, filtering out")),!1):a.enabled?a.streaming_enabled?!0:(console.log("Stream ".concat(a.name," is not configured for HLS, filtering out")),!1):(console.log("Stream ".concat(a.name," is inactive, filtering out")),!1));return console.log("Filtered streams for WebRTC view:",u),u||[]}catch(e){return console.error("Error loading streams for WebRTC view:",e),y("Error loading streams: "+e.message),[]}},C=()=>{switch(g){case"1":return 1;case"2":return 2;case"4":return 4;case"6":return 6;case"9":return 9;case"16":return 16;default:return 4}},K=()=>{if(!$.current)return;const e=$.current.querySelector(".placeholder");if($.current.innerHTML="",e&&d.length===0){$.current.appendChild(e);return}let c=d;if(g==="1"&&x)c=d.filter(r=>r.name===x);else{const r=C(),o=Math.ceil(d.length/r);if(p>=o){I(Math.max(0,o-1));return}const t=p*r,s=Math.min(t+r,d.length);c=d.slice(t,s)}const i=c.map(r=>r.name);Object.keys(f.current).forEach(r=>{i.includes(r)||(console.log("Cleaning up WebRTC connection for stream ".concat(r," (not visible in current view)")),S(r))}),c.forEach(r=>{const o=r.id||r.name,t=document.createElement("div");t.className="video-cell",t.innerHTML='\n        <video id="video-'.concat(r.name.replace(/\s+/g,"-"),'" autoplay muted></video>\n        <div class="stream-info">\n          <span>').concat(r.name,"</span>\n          <span>").concat(r.width,"x").concat(r.height," Â· ").concat(r.fps,'fps</span>\n          <div class="stream-controls">\n            <button class="snapshot-btn" data-id="').concat(o,'" data-name="').concat(r.name,'">\n              <span>ðŸ“·</span> Snapshot\n            </button>\n            <button class="fullscreen-btn" data-id="').concat(o,'" data-name="').concat(r.name,'">\n              <span>â›¶</span> Fullscreen\n            </button>\n          </div>\n        </div>\n        <div class="loading-indicator">\n          <div class="loading-spinner"></div>\n          <span>Connecting WebRTC...</span>\n        </div>\n      '),$.current.appendChild(t),k(r);const s=t.querySelector(".snapshot-btn");s&&s.addEventListener("click",()=>{X(o)});const n=t.querySelector(".fullscreen-btn");n&&n.addEventListener("click",()=>{Y(r.name)})})},k=e=>{const c="video-".concat(e.name.replace(/\s+/g,"-")),i=document.getElementById(c),r=i?i.closest(".video-cell"):null;if(!i||!r)return;const o=r.querySelector(".loading-indicator");o&&(o.style.display="flex");const t="canvas-".concat(e.name.replace(/\s+/g,"-"));let s=document.getElementById(t);s||(s=document.createElement("canvas"),s.id=t,s.className="detection-overlay",s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.pointerEvents="none",r.appendChild(s));const n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}],iceTransportPolicy:"all",bundlePolicy:"balanced",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});f.current[e.name]=n,n.ontrack=l=>{console.log("Track received for stream ".concat(e.name,":"),l),l.track.kind==="video"&&(i.srcObject=l.streams[0],i.onloadeddata=()=>{o&&(o.style.display="none")})},n.onicecandidate=l=>{l.candidate&&console.log("ICE candidate for stream ".concat(e.name,":"),l.candidate)},n.oniceconnectionstatechange=()=>{console.log("ICE connection state for stream ".concat(e.name,":"),n.iceConnectionState),(n.iceConnectionState==="failed"||n.iceConnectionState==="disconnected")&&R(e.name,"WebRTC connection failed")},n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const u={offerToReceiveAudio:!0,offerToReceiveVideo:!0},a=setTimeout(()=>{console.warn("WebRTC setup timed out for stream ".concat(e.name)),R(e.name,"WebRTC setup timed out"),f.current[e.name]&&S(e.name)},15e3);n.createOffer(u).then(l=>(console.log("Created offer for stream ".concat(e.name,":"),l),console.log("Original SDP for stream ".concat(e.name,":"),l.sdp),(!l.sdp.includes("a=ice-ufrag:")||!l.sdp.includes("a=ice-pwd:"))&&console.warn("SDP for stream ".concat(e.name," is missing ice-ufrag or ice-pwd!")),console.log("Using original offer for stream ".concat(e.name)),n.setLocalDescription(l))).then(()=>(console.log("Set local description for stream ".concat(e.name)),Q(e.name,n.localDescription))).then(l=>(console.log("Received answer for stream ".concat(e.name,":"),l),n.setRemoteDescription(new RTCSessionDescription(l)))).then(()=>{console.log("Set remote description for stream ".concat(e.name)),clearTimeout(a),console.log("Stream ".concat(e.name," detection settings:"),{detection_based_recording:e.detection_based_recording,detection_model:e.detection_model,detection_threshold:e.detection_threshold}),e.detection_based_recording&&e.detection_model?(console.log("Starting detection polling for stream ".concat(e.name)),ce(e.name,s,i,O.current)):console.log("Detection not enabled for stream ".concat(e.name))}).catch(l=>{clearTimeout(a),console.error("Error setting up WebRTC for stream ".concat(e.name,":"),l),R(e.name,l.message)})},Q=async(e,c)=>{try{const i=localStorage.getItem("auth"),r={type:c.type,sdp:c.sdp};console.log("Sending formatted offer for stream ".concat(e,":"),r);const o=new AbortController,t=o.signal,s=setTimeout(()=>{console.warn("Aborting WebRTC offer request for stream ".concat(e," due to timeout")),o.abort()},8e3);try{const n=await fetch("/api/webrtc?src=".concat(encodeURIComponent(e)),{method:"POST",headers:{"Content-Type":"application/json",...i?{Authorization:"Basic "+i}:{}},body:JSON.stringify(r),signal:t});if(clearTimeout(s),!n.ok)throw new Error("Failed to send offer: ".concat(n.status," ").concat(n.statusText));const u=new AbortController,a=u.signal,l=setTimeout(()=>{console.warn("Aborting JSON parsing for stream ".concat(e," due to timeout")),u.abort()},5e3);try{const v=await n.text();clearTimeout(l);try{return JSON.parse(v)}catch(m){throw console.error("Error parsing JSON for stream ".concat(e,":"),m),console.log("Raw response text: ".concat(v)),new Error("Failed to parse WebRTC answer: ".concat(m.message))}}catch(v){throw clearTimeout(l),v.name==="AbortError"?new Error("WebRTC answer parsing timed out for stream ".concat(e)):v}}catch(n){throw clearTimeout(s),n.name==="AbortError"?new Error("WebRTC offer request timed out for stream ".concat(e)):n}}catch(i){throw console.error("Error sending offer for stream ".concat(e,":"),i),i}},R=(e,c)=>{const i="video-".concat(e.replace(/\s+/g,"-")),r=document.getElementById(i),o=r?r.closest(".video-cell"):null;if(!o)return;const t=o.querySelector(".loading-indicator");t&&(t.style.display="none");let s=o.querySelector(".error-indicator");s||(s=document.createElement("div"),s.className="error-indicator",o.appendChild(s)),s.innerHTML='\n      <div class="error-icon">!</div>\n      <p>'.concat(c||"WebRTC connection failed",'</p>\n      <button class="retry-button mt-4 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Retry</button>\n    ');const n=s.querySelector(".retry-button");n&&n.addEventListener("click",()=>{t&&(t.style.display="flex"),s.style.display="none",S(e),fetch("/api/streams/".concat(encodeURIComponent(e))).then(u=>u.json()).then(u=>{k(u)}).catch(u=>{console.error("Error fetching stream info:",u),s.style.display="flex";const a=s.querySelector("p");a&&(a.textContent="Could not reconnect: "+u.message),t&&(t.style.display="none")})})},S=e=>{f.current[e]&&(f.current[e].close(),delete f.current[e]);const c="video-".concat(e.replace(/\s+/g,"-")),i=document.getElementById(c);i&&(i.srcObject=null),le(e,O.current)},M=()=>{Object.keys(f.current).forEach(e=>{S(e)})},X=e=>{const c=document.querySelector('.snapshot-btn[data-id="'.concat(e,'"]'));if(!c){console.error("Stream element not found for ID:",e);return}const i=c.getAttribute("data-name");if(!i){console.error("Stream name not found for ID:",e);return}const r="video-".concat(i.replace(/\s+/g,"-")),o=document.getElementById(r);if(!o){console.error("Video element not found for stream:",i);return}const t=document.createElement("canvas");if(t.width=o.videoWidth,t.height=o.videoHeight,t.width===0||t.height===0){console.error("Invalid video dimensions:",t.width,t.height),y("Cannot take snapshot: Video not loaded or has invalid dimensions");return}t.getContext("2d").drawImage(o,0,0,t.width,t.height);try{window.__snapshotCanvas=t;const n=new Date().toISOString().replace(/[:.]/g,"-"),u="snapshot-".concat(i.replace(/\s+/g,"-"),"-").concat(n,".jpg");window.__snapshotFileName=u,re(t.toDataURL("image/jpeg",.95),"Snapshot: ".concat(i)),y("Snapshot taken successfully")}catch(n){console.error("Error creating snapshot:",n),y("Failed to create snapshot: "+n.message)}},Y=e=>{const c="video-".concat(e.replace(/\s+/g,"-")),i=document.getElementById(c),r=i?i.closest(".video-cell"):null;if(!r){console.error("Stream not found:",e);return}document.fullscreenElement?document.exitFullscreen():r.requestFullscreen().catch(o=>{console.error("Error attempting to enable fullscreen: ".concat(o.message)),y("Could not enable fullscreen mode: ".concat(o.message))})};return w(G||(G=h(['\n    <section id="live-page" class="page">\n      <div class="page-header flex justify-between items-center mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">\n        <div class="flex items-center space-x-2">\n          <h2 class="text-xl font-bold mr-4">Live View</h2>\n          <div class="flex space-x-2">\n            <button \n              id="hls-toggle-btn" \n              class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"\n              onClick=','\n            >\n              HLS View\n            </button>\n            <button \n              id="fullscreen-btn" \n              class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800"\n              onClick=','\n            >\n              Fullscreen\n            </button>\n          </div>\n        </div>\n        <div class="controls flex items-center space-x-2">\n          <select \n            id="layout-selector" \n            class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600"\n            value=',"\n            onChange=",'\n          >\n            <option value="1">Single View</option>\n            <option value="2">2x1 Grid</option>\n            <option value="4" selected>2x2 Grid</option>\n            <option value="6">2x3 Grid</option>\n            <option value="9">3x3 Grid</option>\n            <option value="16">4x4 Grid</option>\n          </select>\n          \n          ','\n        </div>\n      </div>\n      \n      <div class="flex flex-col space-y-4">\n        <div \n          id="video-grid" \n          class=',"\n          ref=","\n        >\n          ","\n          <!-- Video cells will be dynamically added by the updateVideoGrid function -->\n        </div>\n        \n        ","\n      </div>\n    </section>\n  "])),()=>window.location.href="/hls.html",()=>se(W,j),g,e=>{U(e.target.value),I(0)},g==="1"&&w(q||(q=h(['\n            <select \n              id="stream-selector" \n              class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600"\n              value=',"\n              onChange=","\n            >\n              ","\n            </select>\n          "])),x,e=>L(e.target.value),d.map(e=>w(B||(B=h(["\n                <option key="," value=",">","</option>\n              "])),e.name,e.name,e.name))),"video-container layout-".concat(g),$,J?w(A||(A=h(['\n            <div class="flex justify-center items-center col-span-full row-span-full h-64 w-full">\n              <div class="flex flex-col items-center justify-center py-8">\n                <div class="inline-block animate-spin rounded-full border-4 border-gray-300 dark:border-gray-600 border-t-blue-600 dark:border-t-blue-500 w-16 h-16"></div>\n                <p class="mt-4 text-gray-700 dark:text-gray-300">Loading streams...</p>\n              </div>\n            </div>\n          ']))):d.length===0?w(D||(D=h(['\n            <div class="placeholder flex flex-col justify-center items-center col-span-full row-span-full bg-white dark:bg-gray-800 rounded-lg shadow-md text-center p-8">\n              <p class="mb-6 text-gray-600 dark:text-gray-300 text-lg">No streams configured</p>\n              <a href="streams.html" class="btn-primary px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Configure Streams</a>\n            </div>\n          ']))):null,g!=="1"&&d.length>C()?w(V||(V=h(['\n          <div class="pagination-controls flex justify-center items-center space-x-4 mt-4">\n            <button \n              class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"\n              onClick=',"\n              disabled=",'\n            >\n              Previous\n            </button>\n            <span class="text-gray-700 dark:text-gray-300">\n              Page '," of ",'\n            </span>\n            <button \n              class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed"\n              onClick=',"\n              disabled=","\n            >\n              Next\n            </button>\n          </div>\n        "])),()=>I(Math.max(0,p-1)),p===0,p+1,Math.ceil(d.length/C()),()=>I(Math.min(Math.ceil(d.length/C())-1,p+1)),p>=Math.ceil(d.length/C())-1):null)}var H;function ge(){const d=document.getElementById("main-content");d&&ee(async()=>{const{render:b}=await import("./preact-app-Cn527Soc.js").then(g=>g.p);return{render:b}},__vite__mapDeps([0,1]),import.meta.url).then(({render:b})=>{b(w(H||(H=h(["<"," />"])),ae),d)})}export{ae as WebRTCView,ge as loadWebRTCView};
//# sourceMappingURL=WebRTCView-CiLpkVw0.js.map
