var A=Object.freeze,G=Object.defineProperty;var W=(s,g)=>A(G(s,"raw",{value:A(g||s.slice())}));import{d as H,y as z,u as n,k as Z,s as F,A as j,b as J,E as K,c as ee,e as te,Q as ne}from"./query-client-DIfHb7sS.js";/* empty css               */import{L as ie}from"./LoadingIndicator-DbxhRnFU.js";import{H as re,F as oe}from"./Footer-mKcwuqt4.js";function ye(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}function se(){const[s,g]=H(!1),[w,T]=H(1);z(()=>{const l=e.subscribe(S=>{g(S.isPlaying),T(S.zoomLevel)});return()=>l()},[]);const p=()=>{console.log("TimelineControls: togglePlayback called"),console.log("TimelineControls: Current state before toggle:",{isPlaying:s,currentTime:e.currentTime,currentSegmentIndex:e.currentSegmentIndex,segmentsCount:e.timelineSegments?e.timelineSegments.length:0}),s?h():R()},h=()=>{e.setState({isPlaying:!1});const l=document.querySelector("#video-player video");l&&l.pause()},R=()=>{if(!e.timelineSegments||e.timelineSegments.length===0){F("No recordings to play","warning");return}console.log("TimelineControls: resumePlayback called"),console.log("TimelineControls: Current state:",{segments:e.timelineSegments.length,currentSegmentIndex:e.currentSegmentIndex,currentTime:e.currentTime,selectedDate:e.selectedDate});let l=null,S=-1,v=0;if(e.currentTime!==null){console.log("TimelineControls: Using current time to find segment:",e.currentTime);for(let x=0;x<e.timelineSegments.length;x++){const k=e.timelineSegments[x];if(e.currentTime>=k.start_timestamp&&e.currentTime<=k.end_timestamp){l=k,S=x,v=e.currentTime-k.start_timestamp,console.log("TimelineControls: Found segment ".concat(x," containing current time, relative time: ").concat(v,"s"));break}}if(!l){let x=0,k=1/0;for(let t=0;t<e.timelineSegments.length;t++){const r=e.timelineSegments[t],i=(r.start_timestamp+r.end_timestamp)/2,o=Math.abs(e.currentTime-i);o<k&&(k=o,x=t)}l=e.timelineSegments[x],S=x,e.currentTime<l.start_timestamp?v=0:e.currentTime>l.end_timestamp?v=l.end_timestamp-l.start_timestamp:v=e.currentTime-l.start_timestamp,console.log("TimelineControls: Using closest segment ".concat(x,", relative time: ").concat(v,"s"))}}else e.currentSegmentIndex>=0&&e.currentSegmentIndex<e.timelineSegments.length?(S=e.currentSegmentIndex,l=e.timelineSegments[S],v=0,console.log("TimelineControls: Using current segment index ".concat(S))):(S=0,l=e.timelineSegments[0],v=0,console.log("TimelineControls: Falling back to first segment"));console.log("TimelineControls: Playing segment ".concat(S," (ID: ").concat(l.id,") at time ").concat(v,"s")),e.currentSegmentIndex=S,e.preserveCursorPosition?console.log("TimelineControls: Cursor position is locked, keeping current time ".concat(e.currentTime)):e.currentTime!==null&&e.currentTime>=l.start_timestamp&&e.currentTime<=l.end_timestamp?console.log("TimelineControls: Keeping current time ".concat(e.currentTime," within segment")):(e.currentTime=l.start_timestamp+v,console.log("TimelineControls: Setting current time to ".concat(e.currentTime," (segment start + ").concat(v,"s)"))),e.isPlaying=!0,e.directVideoControl=!0,e.setState({}),setTimeout(()=>{console.log("TimelineControls: Resetting directVideoControl flag"),e.directVideoControl=!1,e.setState({})},3e3);const u=document.querySelector("#video-player video");if(u){u.pause();const x=()=>{console.log("TimelineControls: Video metadata loaded, setting time to ".concat(v,"s"));try{console.log("TimelineControls: Video metadata",{duration:u.duration,width:u.videoWidth,height:u.videoHeight,segment:l.id,segmentDuration:l.end_timestamp-l.start_timestamp});let k=v;if(e.preserveCursorPosition&&e.currentTime!==null)if(e.currentTime>=l.start_timestamp&&e.currentTime<=l.end_timestamp)k=e.currentTime-l.start_timestamp,console.log("TimelineControls: Using locked cursor position for playback: ".concat(k,"s"));else{const r=Math.abs(e.currentTime-l.start_timestamp),i=Math.abs(e.currentTime-l.end_timestamp);r<=i?(k=0,console.log("TimelineControls: Cursor outside segment, using start of segment")):(k=l.end_timestamp-l.start_timestamp,console.log("TimelineControls: Cursor outside segment, using end of segment"))}else e.currentTime!==null&&e.currentTime>=l.start_timestamp&&e.currentTime<=l.end_timestamp&&(k=e.currentTime-l.start_timestamp,console.log("TimelineControls: Using cursor position for playback: ".concat(k,"s")));let t=Math.max(0,Math.min(k,u.duration||0));t>0&&t<1&&(t=1,console.log("TimelineControls: Adjusting video time to ".concat(t,"s to prevent snapping to segment start"))),console.log("TimelineControls: Setting video time to ".concat(t,"s")),u.currentTime=t,setTimeout(()=>{e.isPlaying&&(console.log("TimelineControls: Starting video playback"),u.play().then(()=>{console.log("TimelineControls: Video playback started successfully");const r=(o=1)=>{o>5||setTimeout(()=>{u.paused&&e.isPlaying&&(console.log("TimelineControls: Video paused unexpectedly (attempt ".concat(o,"), trying to resume")),u.play().catch(c=>{console.error("Error resuming video (attempt ".concat(o,"):"),c)}),r(o+1))},500*o)};r();const i=l.end_timestamp-l.start_timestamp;if(console.log("TimelineControls: Segment duration: ".concat(i,"s, video duration: ").concat(u.duration,"s")),u.duration<i-1){console.log("TimelineControls: Video duration is shorter than segment duration, will monitor playback");const o=setInterval(()=>{if(!e.isPlaying||!u){clearInterval(o);return}u.currentTime>u.duration-.5&&v+u.currentTime<i&&(console.log("TimelineControls: Reached end of video but not end of segment, restarting video"),u.currentTime=0,u.play().catch(c=>{console.error("Error restarting video:",c)}))},500)}}).catch(r=>{console.error("Error playing video:",r),F("Error playing video: "+r.message,"error")}))},100)}catch(k){console.error("TimelineControls: Error in handleMetadataLoaded:",k)}finally{u.removeEventListener("loadedmetadata",x)}};u.addEventListener("loadedmetadata",x),console.log("TimelineControls: Loading video from segment ".concat(l.id)),u.src="/api/recordings/play/".concat(l.id,"?t=").concat(Date.now()),u.load()}else console.error("TimelineControls: No video element found"),F("Error: Video player not found","error")},_=()=>{if(w<8){const l=w*2;e.setState({zoomLevel:l}),F("Zoomed in: ".concat(24/l," hours view"),"info")}};return n("div",{className:"timeline-controls flex justify-between items-center mb-2",children:[n("div",{className:"flex items-center",children:[n("button",{id:"play-button",className:"w-10 h-10 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-green-500 focus:ring-offset-1 transition-colors shadow-sm mr-2",onClick:p,title:s?"Pause":"Play from current position",children:n("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s?n(Z,{children:[n("rect",{x:"6",y:"6",width:"4",height:"12",rx:"1",fill:"white"}),n("rect",{x:"14",y:"6",width:"4",height:"12",rx:"1",fill:"white"})]}):n(Z,{children:n("path",{d:"M8 5.14v14l11-7-11-7z",fill:"white"})})})}),n("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:"Play from current position"})]}),n("div",{className:"flex items-center gap-1",children:[n("span",{className:"text-xs text-gray-600 dark:text-gray-300 mr-1",children:"Zoom:"}),n("button",{id:"zoom-out-button",className:"w-6 h-6 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors",onClick:()=>{if(w>1){const l=w/2;e.setState({zoomLevel:l}),F("Zoomed out: ".concat(24/l," hours view"),"info")}},title:"Zoom Out (Show more time)",disabled:w<=1,children:n("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:n("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"})})}),n("button",{id:"zoom-in-button",className:"w-6 h-6 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors",onClick:_,title:"Zoom In (Show less time)",disabled:w>=8,children:n("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:n("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"})})})]})]})}function le(){const[s,g]=H(0),[w,T]=H(24),[p,h]=H(1);return z(()=>{const _=e.subscribe(f=>{console.log("TimelineRuler: State update received",{zoomLevel:f.zoomLevel,segmentsCount:f.timelineSegments?f.timelineSegments.length:0,currentTime:f.currentTime});const l=24/f.zoomLevel;let S=12;if(f.currentTime!==null){const u=new Date(f.currentTime*1e3);S=u.getHours()+u.getMinutes()/60+u.getSeconds()/3600}else if(f.timelineSegments&&f.timelineSegments.length>0){let u=24,x=0;f.timelineSegments.forEach(k=>{const t=new Date(k.start_timestamp*1e3),r=new Date(k.end_timestamp*1e3),i=t.getHours()+t.getMinutes()/60+t.getSeconds()/3600,o=r.getHours()+r.getMinutes()/60+r.getSeconds()/3600;u=Math.min(u,i),x=Math.max(x,o)}),S=(u+x)/2,console.log("TimelineRuler: Calculated center from segments",{earliestHour:u,latestHour:x,centerHour:S})}let v=Math.max(0,S-l/2),P=Math.min(24,v+l);P===24&&l<24?(v=Math.max(0,24-l),P=24):v===0&&l<24&&(P=Math.min(24,l)),g(v),T(P),h(f.zoomLevel),console.log("TimelineRuler: Calculated time range",{newStartHour:v,newEndHour:P,hoursPerView:l,centerHour:S}),(e.timelineStartHour!==v||e.timelineEndHour!==P)&&(console.log("TimelineRuler: Updating global state with new time range"),e.setState({timelineStartHour:v,timelineEndHour:P}))});return()=>_()},[]),n("div",{className:"timeline-ruler relative w-full h-8 bg-gray-300 dark:bg-gray-800 border-b border-gray-400 dark:border-gray-600",children:[(()=>{const _=[];for(let f=Math.floor(s);f<=Math.ceil(w);f++)if(f>=0&&f<=24){const l=(f-s)/(w-s)*100;if(_.push(n("div",{className:"absolute top-0 w-px h-5 bg-gray-500 dark:bg-gray-400",style:{left:"".concat(l,"%")}},"tick-".concat(f))),_.push(n("div",{className:"absolute top-0 text-xs text-gray-600 dark:text-gray-300 transform -translate-x-1/2",style:{left:"".concat(l,"%")},children:[f,":00"]},"label-".concat(f))),f<24&&p>=2){const S=(f+.5-s)/(w-s)*100;if(_.push(n("div",{className:"absolute top-2 w-px h-3 bg-gray-400 dark:bg-gray-500",style:{left:"".concat(S,"%")}},"tick-".concat(f,"-30"))),p>=4){const v=(f+.25-s)/(w-s)*100,P=(f+.75-s)/(w-s)*100;_.push(n("div",{className:"absolute top-3 w-px h-2 bg-gray-400 dark:bg-gray-500",style:{left:"".concat(v,"%")}},"tick-".concat(f,"-15"))),_.push(n("div",{className:"absolute top-3 w-px h-2 bg-gray-400 dark:bg-gray-500",style:{left:"".concat(P,"%")}},"tick-".concat(f,"-45")))}}}return _})(),n("div",{className:"absolute bottom-0 left-0 text-xs text-gray-500 px-1",children:["Zoom: ",p,"x (",Math.round(24/p)," hours)"]})]})}var Q;function ae({segments:s}){const[g,w]=H(s||[]),[T,p]=H(0),[h,R]=H(24),[_,f]=H(-1);z(()=>{console.log("TimelineSegments: Received segments from props: ".concat(s?s.length:0)),s&&s.length>0&&w(s)},[s]);const l=j(null),S=j(!1),v=j(0),P=j([]);z(()=>{const t=e.subscribe(r=>{console.log("TimelineSegments: State update received, segments: ".concat(r.timelineSegments?r.timelineSegments.length:0)),r.timelineSegments&&(!P.current||r.timelineSegments.length!==P.current.length||JSON.stringify(r.timelineSegments)!==JSON.stringify(P.current)||r.forceReload)&&(console.log("TimelineSegments: Updating segments (".concat(r.timelineSegments.length,")")),w(r.timelineSegments),P.current=[...r.timelineSegments],v.current=Date.now());const i=r.timelineStartHour!==void 0?r.timelineStartHour:0,o=r.timelineEndHour!==void 0?r.timelineEndHour:24;console.log("TimelineSegments: Time range update - startHour: ".concat(i,", endHour: ").concat(o)),p(i),R(o),f(r.currentSegmentIndex||-1)});return e.timelineSegments&&e.timelineSegments.length>0&&(console.log("TimelineSegments: Initial load of segments (".concat(e.timelineSegments.length,")")),w(e.timelineSegments),P.current=[...e.timelineSegments],f(e.currentSegmentIndex||0),e.timelineStartHour!==void 0&&p(e.timelineStartHour),e.timelineEndHour!==void 0&&R(e.timelineEndHour),v.current=Date.now()),()=>t()},[]),z(()=>{const t=l.current;if(!t)return;const r=c=>{(c.target===t||c.target.classList.contains("timeline-clickable-area"))&&(S.current=!0,u(c),document.addEventListener("mousemove",i),document.addEventListener("mouseup",o))},i=c=>{S.current&&u(c)},o=()=>{S.current=!1,document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",o)};return t.addEventListener("mousedown",r),()=>{t.removeEventListener("mousedown",r),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",o)}},[T,h,g]);const u=t=>{const r=l.current;if(!r)return;const i=r.getBoundingClientRect(),o=t.clientX-i.left,c=i.width,a=o/c,b=T+a*(h-T),m=new Date(e.selectedDate);m.setHours(Math.floor(b)),m.setMinutes(Math.floor(b%1*60)),m.setSeconds(Math.floor(b%1*60%1*60));const C=m.getTime()/1e3;e.setState({currentTime:C,prevCurrentTime:e.currentTime,isPlaying:!1});let $=!1;for(let L=0;L<g.length;L++){const D=g[L],N=D.local_start_timestamp||D.start_timestamp,y=D.local_end_timestamp||D.end_timestamp;if(C>=N&&C<=y){if(console.log("TimelineSegments: Found segment ".concat(L," containing timestamp")),e.setState({currentSegmentIndex:L}),t.target.classList.contains("timeline-segment")){const d=C-N;x(L,d)}$=!0;break}}$||e.setState({currentSegmentIndex:-1})},x=(t,r=null)=>{if(console.log("TimelineSegments: playSegment(".concat(t,", ").concat(r,")")),t<0||t>=g.length){console.warn("TimelineSegments: Invalid segment index: ".concat(t));return}const i=g[t],o=i.local_start_timestamp||i.start_timestamp,c=r!==null?o+r:o;e.setState({isPlaying:!1,currentSegmentIndex:-1}),document.body.offsetHeight,setTimeout(()=>{e.setState({currentSegmentIndex:t,currentTime:c,isPlaying:!0,forceReload:!0}),setTimeout(()=>{const a=document.querySelector("#video-player video");a&&(a.pause(),a.removeAttribute("src"),a.load(),a.src="/api/recordings/play/".concat(i.id,"?t=").concat(Date.now()),a.onloadedmetadata=()=>{const b=r!==null?r:0;a.currentTime=b,a.play().catch(m=>console.error("Error playing video:",m))})},50)},50)};return n("div",{className:"timeline-segments relative w-full h-16 pt-2",ref:l,children:(()=>{if(console.log("TimelineSegments: renderSegments called"),console.log("TimelineSegments: segments:",g),console.log("TimelineSegments: startHour:",T,"endHour:",h),!g||g.length===0)return console.log("TimelineSegments: No segments to render"),html(Q||(Q=W(['<div class="text-center text-red-500 font-bold">No segments to display</div>'])));console.log("TimelineSegments: Rendering segments:",g.length);const t=[],r=new Map;console.log("TimelineSegments: Starting to process segments");let i=0,o=0;g.forEach((m,C)=>{const $=m.start_timestamp,L=m.end_timestamp,D=new Date($*1e3),N=new Date(L*1e3),y=D.getHours()+D.getMinutes()/60+D.getSeconds()/3600,d=N.getHours()+N.getMinutes()/60+N.getSeconds()/3600;if(d<T||y>h){o++,C<5&&console.log("TimelineSegments: Skipping segment ".concat(C,", startHour=").concat(y,", endHour=").concat(d,", visible range=").concat(T,"-").concat(h));return}i++;const I=Math.floor(y),U=Math.min(Math.ceil(d),24);for(let E=I;E<U;E++)E>=T&&E<=h&&(r.has(E)||r.set(E,[]),r.get(E).push(C))});const c=[];let a=null;[...g].sort((m,C)=>m.start_timestamp-C.start_timestamp).forEach((m,C)=>{if(!a)a={...m,originalIndices:[C]};else{const $=m.start_timestamp,L=a.end_timestamp;$-L<=1?(a.end_timestamp=m.end_timestamp,a.originalIndices.push(C),m.has_detection&&(a.has_detection=!0)):(c.push(a),a={...m,originalIndices:[C]})}}),a&&c.push(a),c.forEach((m,C)=>{const $=m.start_timestamp,L=m.end_timestamp,D=e.timestampToTimelineHour($),N=e.timestampToTimelineHour(L);if(console.log("TimelineSegments: Segment timestamps",{segmentId:m.id,startTimestamp:$,endTimestamp:L,startTimeLocal:new Date($*1e3).toLocaleString(),endTimeLocal:new Date(L*1e3).toLocaleString(),startHourFloat:D,endHourFloat:N}),N<T||D>h)return;const y=Math.max(D,T),d=Math.min(N,h),I=(y-T)/(h-T)*100,U=(d-y)/(h-T)*100,E=Math.round(L-$),q="".concat(E,"s"),M=new Date($*1e3).toLocaleTimeString(),V=new Date(L*1e3).toLocaleTimeString();t.push(n("div",{className:"timeline-segment absolute rounded-sm transition-all duration-200 ".concat(m.has_detection?"bg-red-500":"bg-blue-500"),style:{left:"".concat(I,"%"),width:"".concat(U,"%"),height:"".concat(80,"%"),top:"50%",transform:"translateY(-50%)"},title:"".concat(M," - ").concat(V," (").concat(q,")")},"segment-".concat(C)))});for(let m=Math.floor(T);m<Math.ceil(h);m++)if(!r.has(m)){const C=(m-T)/(h-T)*100,$=100/(h-T);t.push(n("div",{className:"timeline-clickable-area absolute h-full cursor-pointer",style:{left:"".concat(C,"%"),width:"".concat($,"%")},"data-hour":m},"clickable-".concat(m)))}return console.log("TimelineSegments: Rendering complete. Total: ".concat(g.length,", Visible: ").concat(i,", Skipped: ").concat(o,", Final rendered: ").concat(t.length)),t})()})}function me(){const[s,g]=H(0),[w,T]=H(!1),[p,h]=H(0),[R,_]=H(24),[f,l]=H(null),[S,v]=H(!1),P=j(null);j(null);const u=j(0),k=j(((i,o)=>{let c;return function(...a){c&&clearTimeout(c),c=setTimeout(()=>{i.apply(this,a)},o)}})((i,o,c)=>{t(i,o,c)},100)).current;z(()=>{const i=e.subscribe(o=>{console.log("TimelineCursor: State update received",{currentTime:o.currentTime,startHour:o.timelineStartHour,endHour:o.timelineEndHour,segmentsCount:o.timelineSegments?o.timelineSegments.length:0,isDragging:S,userControllingCursor:o.userControllingCursor}),h(o.timelineStartHour||0),_(o.timelineEndHour||24),!S&&!o.userControllingCursor&&(l(o.currentTime),r(o.currentTime),k(o.currentTime,o.timelineStartHour||0,o.timelineEndHour||24))});return()=>i()},[S,k]),z(()=>{const i=P.current;if(!i)return;const o=b=>{b.preventDefault(),b.stopPropagation(),console.log("TimelineCursor: Mouse down event"),u.current=b.clientX,v(!0),e.userControllingCursor=!0,e.preserveCursorPosition=!0,e.cursorPositionLocked=!0,e.setState({}),document.addEventListener("mousemove",c),document.addEventListener("mouseup",a)},c=b=>{if(!S)return;const m=i.parentElement;if(!m)return;const C=m.getBoundingClientRect(),$=Math.max(0,Math.min(b.clientX-C.left,C.width)),L=C.width,D=$/L*100;g(D);const N=R-p,y=p+D/100*N,d=e.timelineHourToTimestamp(y,e.selectedDate);l(d),r(d)},a=b=>{if(!S)return;const m=i.parentElement;if(!m)return;const C=m.getBoundingClientRect(),$=Math.max(0,Math.min(b.clientX-C.left,C.width)),L=C.width,D=$/L*100;console.log("TimelineCursor: Mouse up at position",{positionPercent:D,clickX:$,containerWidth:L});const N=R-p,y=p+D/100*N;console.log("TimelineCursor: Calculated hour",{hour:y,startHour:p,endHour:R,hourRange:N});const d=e.timelineHourToTimestamp(y,e.selectedDate);if(console.log("TimelineCursor: Converted hour to timestamp",{hour:y,localDate:new Date(d*1e3).toLocaleString(),timestamp:d}),console.log("TimelineCursor: Converted to timestamp",{timestamp:d,dateTime:new Date(d*1e3).toLocaleString(),selectedDate:e.selectedDate}),console.log("TimelineCursor: Mouse up event"),v(!1),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",a),setTimeout(()=>{console.log("TimelineCursor: Releasing cursor control but preserving position"),e.userControllingCursor=!1,e.setState({})},100),e.currentTime=d,e.timelineSegments&&e.timelineSegments.length>0){const M=e.timelineSegments.find(V=>d>=V.start_timestamp&&d<=V.end_timestamp);if(M&&d-M.start_timestamp<1){const O=M.start_timestamp+1;console.log("TimelineCursor: Adjusting cursor position from ".concat(d," to ").concat(O," to prevent snapping to segment start")),e.currentTime=O}}e.prevCurrentTime=e.currentTime,e.isPlaying=!1,e.setState({});const I=e.timelineSegments||[];console.log("TimelineCursor: Searching for segment containing timestamp",{timestamp:d,segmentsCount:I.length});let U=!1,E=-1,q=1/0;for(let M=0;M<I.length;M++){const V=I[M],O=V.local_start_timestamp||V.start_timestamp,B=V.local_end_timestamp||V.end_timestamp;if(M<3&&console.log("TimelineCursor: Segment ".concat(M),{startTimestamp:O,endTimestamp:B,startTime:new Date(O*1e3).toLocaleTimeString(),endTime:new Date(B*1e3).toLocaleTimeString()}),d>=O&&d<=B){console.log("TimelineCursor: Found exact match at segment ".concat(M)),e.currentSegmentIndex=M,e.setState({}),U=!0;break}const Y=(O+B)/2,X=Math.abs(d-Y);X<q&&(q=X,E=M)}U||(E>=0?(console.log("TimelineCursor: No exact match, using closest segment ".concat(E)),e.currentSegmentIndex=E,e.setState({})):(console.log("TimelineCursor: No segments found at all"),e.currentSegmentIndex=-1,e.setState({})))};return i.addEventListener("mousedown",o),()=>{i.removeEventListener("mousedown",o),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",a)}},[P.current,p,R,S]);const t=(i,o,c)=>{if(console.log("TimelineCursor: updateCursorPosition called",{time:i,startHr:o,endHr:c}),i===null){console.log("TimelineCursor: No current time, hiding cursor"),T(!1);return}const a=new Date(i*1e3),b=a.getHours()+a.getMinutes()/60+a.getSeconds()/3600;if(console.log("TimelineCursor: Calculated hour",{hour:b,timeString:a.toLocaleTimeString()}),b<o||b>c){console.log("TimelineCursor: Time outside visible range, hiding cursor"),T(!1);return}const m=(b-o)/(c-o)*100;console.log("TimelineCursor: Calculated position",{position:m,hour:b,startHr:o,endHr:c}),g(m),T(!0)},r=i=>{if(i===null)return;const o=document.getElementById("time-display");if(!o)return;const c=new Date(i*1e3),a=c.getHours().toString().padStart(2,"0"),b=c.getMinutes().toString().padStart(2,"0"),m=c.getSeconds().toString().padStart(2,"0");o.textContent="".concat(a,":").concat(b,":").concat(m)};return z(()=>{console.log("TimelineCursor: Initializing cursor position"),console.log("TimelineCursor: Initial state",{currentTime:e.currentTime,startHour:e.timelineStartHour,endHour:e.timelineEndHour,segments:e.timelineSegments?e.timelineSegments.length:0});const i=()=>{if(console.log("TimelineCursor: Checking timelineState directly",{currentTime:e.currentTime,segmentsLength:e.timelineSegments?e.timelineSegments.length:0,currentSegmentIndex:e.currentSegmentIndex}),e.currentTime)return console.log("TimelineCursor: Setting initial cursor position with current time"),T(!0),t(e.currentTime,e.timelineStartHour||0,e.timelineEndHour||24),!0;if(e.timelineSegments&&e.timelineSegments.length>0){console.log("TimelineCursor: Using first segment start time for cursor");const a=e.timelineSegments[0].start_timestamp;return console.log("TimelineCursor: Directly setting timelineState properties"),e.currentTime=a,e.currentSegmentIndex=0,e.setState({}),T(!0),t(a,e.timelineStartHour||0,e.timelineEndHour||24),!0}return!1};i()||(console.log("TimelineCursor: Initial initialization failed, will retry after delay"),[100,300,500,1e3].forEach((a,b)=>{setTimeout(()=>{w||(console.log("TimelineCursor: Retry initialization attempt ".concat(b+1)),i())},a)}))},[]),n("div",{ref:P,className:"timeline-cursor absolute top-0 h-full z-50 transition-all duration-100 cursor-ew-resize",style:{left:"".concat(s,"%"),display:w?"block":"none",pointerEvents:"auto",width:"7px",marginLeft:"-3.5px"},children:[n("div",{className:"absolute top-0 bottom-0 left-0 w-full"}),n("div",{className:"absolute top-0 bottom-0 w-0.5 bg-orange-500 left-1/2 transform -translate-x-1/2 pointer-events-none"}),n("div",{className:"absolute top-0 left-1/2 w-4 h-4 bg-black rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-md pointer-events-none"}),n("div",{className:"absolute bottom-0 left-1/2 w-4 h-4 bg-black rounded-full transform -translate-x-1/2 translate-y-1/2 shadow-md pointer-events-none"})]})}function ce(){const[s,g]=H(1),w=[.25,.5,1,1.5,2,4];z(()=>{const p=e.subscribe(h=>{g(h.playbackSpeed)});return()=>p()},[]);const T=p=>{const h=document.querySelector("#video-player video");h&&(h.playbackRate=p),e.setState({playbackSpeed:p}),F("Playback speed: ".concat(p,"x"),"info")};return n("div",{className:"mt-2 mb-4 p-2 border border-green-500 rounded-lg bg-white dark:bg-gray-800 shadow-sm",children:n("div",{className:"flex flex-col items-center",children:[n("div",{className:"text-sm font-semibold mb-2 text-gray-700 dark:text-gray-300",children:"Playback Speed"}),n("div",{className:"flex flex-wrap justify-center gap-1",children:w.map(p=>n("button",{className:"speed-btn px-2 py-1 text-sm rounded-full ".concat(p===s?"bg-green-500 text-white":"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600","\n                font-medium transition-all focus:outline-none focus:ring-1 focus:ring-green-500 focus:ring-opacity-50"),"data-speed":p,onClick:()=>T(p),children:p===1?"1× (Normal)":"".concat(p,"×")},"speed-".concat(p)))}),n("div",{className:"mt-1 text-xs font-medium text-green-600 dark:text-green-400",children:["Current: ",s,"× ",s===1?"(Normal)":""]})]})})}function de(){const[s,g]=H(-1),[w,T]=H(!1),[p,h]=H([]),[R,_]=H(1),f=j(null),l=j(null),S=j(null);z(()=>{const t=e.subscribe(r=>{g(r.currentSegmentIndex),T(r.isPlaying),h(r.timelineSegments||[]),_(r.playbackSpeed),v(r)});return()=>t()},[]);const v=t=>{const r=f.current;if(!r||!t.timelineSegments||t.timelineSegments.length===0||t.currentSegmentIndex<0||t.currentSegmentIndex>=t.timelineSegments.length)return;const i=t.timelineSegments[t.currentSegmentIndex];if(!i)return;const o=S.current!==i.id,c=o;let a=0;t.currentTime!==null&&(t.currentTime>=i.start_timestamp&&t.currentTime<=i.end_timestamp?(a=t.currentTime-i.start_timestamp,console.log("Current time ".concat(t.currentTime," is within segment ").concat(i.id,", relative time: ").concat(a,"s"))):t.currentTime<i.start_timestamp?(a=0,console.log("Current time ".concat(t.currentTime," is before segment ").concat(i.id,", starting at beginning"))):(a=i.end_timestamp-i.start_timestamp,console.log("Current time ".concat(t.currentTime," is after segment ").concat(i.id,", starting at end"))));const b=t.prevCurrentTime!==null&&Math.abs(t.currentTime-t.prevCurrentTime)>1;o&&(console.log("Segment changed from ".concat(S.current," to ").concat(i.id)),S.current=i.id),c?(console.log("Loading new segment ".concat(i.id," (segmentChanged: ").concat(o,")")),P(i,a,t.isPlaying)):b?(console.log("Seeking to ".concat(a,"s within current segment")),r.currentTime=a):t.isPlaying&&r.paused?r.play().catch(m=>{console.error("Error playing video:",m)}):!t.isPlaying&&!r.paused&&r.pause(),r.playbackRate!==t.playbackSpeed&&(r.playbackRate=t.playbackSpeed)},P=(t,r=0,i=!1)=>{const o=f.current;if(!o)return;console.log("Loading segment ".concat(t.id," at time ").concat(r,"s, autoplay: ").concat(i)),o.pause();const c="/api/recordings/play/".concat(t.id,"?t=").concat(Date.now()),a=()=>{console.log("Video metadata loaded");let b=r;if(e.preserveCursorPosition&&e.currentTime!==null)if(e.currentTime>=t.start_timestamp&&e.currentTime<=t.end_timestamp)b=e.currentTime-t.start_timestamp,console.log("TimelinePlayer: Using locked cursor position for playback: ".concat(b,"s"));else{const $=Math.abs(e.currentTime-t.start_timestamp),L=Math.abs(e.currentTime-t.end_timestamp);$<=L?(b=0,console.log("TimelinePlayer: Cursor outside segment, using start of segment")):(b=t.end_timestamp-t.start_timestamp,console.log("TimelinePlayer: Cursor outside segment, using end of segment"))}else e.currentTime!==null&&e.currentTime>=t.start_timestamp&&e.currentTime<=t.end_timestamp&&(b=e.currentTime-t.start_timestamp,console.log("TimelinePlayer: Using cursor position for playback: ".concat(b,"s")));const m=t.end_timestamp-t.start_timestamp;let C=Math.min(Math.max(0,b),m);C>0&&C<1&&(C=1,console.log("TimelinePlayer: Adjusting seek time to ".concat(C,"s to prevent snapping to segment start"))),console.log("TimelinePlayer: Setting video time to ".concat(C,"s (requested: ").concat(b,"s, segment duration: ").concat(m,"s)")),o.currentTime=C,o.playbackRate=R,i&&o.play().catch($=>{console.error("Error playing video:",$),F("Error playing video: "+$.message,"error")}),o.removeEventListener("loadedmetadata",a)};o.addEventListener("loadedmetadata",a),o.src=c,o.load()},u=()=>{if(console.log("Video ended"),s<p.length-1){const t=s+1;console.log("Playing next segment ".concat(t));const r=e.userControllingCursor;e.directVideoControl=!0,e.setState({currentSegmentIndex:t,currentTime:r?e.currentTime:p[t].start_timestamp,isPlaying:!0,forceReload:!0}),setTimeout(()=>{e.directVideoControl=!1,e.setState({})},1e3)}else console.log("End of all segments"),e.setState({isPlaying:!1})},x=()=>{const t=f.current;if(!t||s<0||!p||p.length===0||s>=p.length)return;const r=p[s];if(!r)return;const i=r.start_timestamp+t.currentTime;if(console.log("TimelinePlayer: Current time",{videoTime:t.currentTime,segmentStart:r.start_timestamp,calculatedTime:i,localTime:new Date(i*1e3).toLocaleString()}),k(i),e.userControllingCursor){console.log("TimelinePlayer: User is controlling cursor, not updating timeline state");return}if(e.cursorPositionLocked){console.log("TimelinePlayer: Cursor position is locked, not updating timeline state");return}if(e.directVideoControl){console.log("TimelinePlayer: Direct video control active, not updating timeline state");return}e.setState({currentTime:i,prevCurrentTime:l.current}),l.current=i},k=t=>{if(t===null)return;const r=document.getElementById("time-display");if(!r)return;const i=e.timestampToTimelineHour(t),o=Math.floor(i).toString().padStart(2,"0"),c=Math.floor(i%1*60).toString().padStart(2,"0"),a=Math.floor(i%1*60%1*60).toString().padStart(2,"0");r.textContent="".concat(o,":").concat(c,":").concat(a),console.log("TimelinePlayer: Updated time display",{timestamp:t,hour:i,formatted:"".concat(o,":").concat(c,":").concat(a),localTime:new Date(t*1e3).toLocaleString()})};return n(Z,{children:[n("div",{className:"timeline-player-container mb-2",id:"video-player",children:n("div",{className:"relative w-full bg-black rounded-lg shadow-md",style:{aspectRatio:"16/9"},children:[n("video",{ref:f,className:"w-full h-full object-contain",controls:!0,autoPlay:!1,muted:!1,playsInline:!0,onEnded:u,onTimeUpdate:x}),n("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-white text-center p-4 ".concat(s>=0&&p.length>0?"hidden":""),children:n("div",{children:[n("p",{className:"mb-2",children:"No valid segment selected."}),n("p",{className:"text-sm",children:"Click on a segment in the timeline or use the play button to start playback."})]})})]})}),n(ce,{})]})}function ue(s,g){const w=g?new Date(g):new Date;w.setHours(0,0,0,0);const T=w.getTime()+s*60*60*1e3;return Math.floor(T/1e3)}function ge(s){const g=new Date(s*1e3);return g.getHours()+g.getMinutes()/60+g.getSeconds()/3600}const e={streams:[],timelineSegments:[],selectedStream:null,selectedDate:null,isPlaying:!1,currentSegmentIndex:-1,zoomLevel:1,timelineStartHour:0,timelineEndHour:24,currentTime:null,prevCurrentTime:null,playbackSpeed:1,showOnlySegments:!0,forceReload:!1,userControllingCursor:!1,preserveCursorPosition:!1,cursorPositionLocked:!1,timelineHourToTimestamp:ue,timestampToTimelineHour:ge,listeners:new Set,lastUpdateTime:0,pendingUpdates:{},setState(s){const g=Date.now();if(console.log("timelineState: setState called with",s),console.log("timelineState: current state before update",{currentTime:this.currentTime,currentSegmentIndex:this.currentSegmentIndex,segmentsLength:this.timelineSegments.length}),s.currentTime!==void 0&&!s.currentSegmentIndex&&!s.isPlaying&&g-this.lastUpdateTime<250){console.log("timelineState: Skipping frequent time update");return}Object.assign(this,s),s.forceReload&&(this.forceReload=!1),this.lastUpdateTime=g,console.log("timelineState: state after update",{currentTime:this.currentTime,currentSegmentIndex:this.currentSegmentIndex,segmentsLength:this.timelineSegments.length}),this.notifyListeners()},subscribe(s){return this.listeners.add(s),()=>this.listeners.delete(s)},notifyListeners(){this.listeners.forEach(s=>s(this))},flushPendingUpdates(){Object.keys(this.pendingUpdates).length>0&&(Object.assign(this,this.pendingUpdates),this.pendingUpdates={},this.lastUpdateTime=Date.now(),this.notifyListeners())}};function pe(s){const g=s.getFullYear(),w=String(s.getMonth()+1).padStart(2,"0"),T=String(s.getDate()).padStart(2,"0");return"".concat(g,"-").concat(w,"-").concat(T)}function he(){const s=new URLSearchParams(window.location.search);return{stream:s.get("stream")||"",date:s.get("date")||pe(new Date)}}function fe(s,g){if(!s)return;const w=new URL(window.location.href);w.searchParams.set("stream",s),w.searchParams.set("date",g),window.history.replaceState({},"",w)}function Te(){const s=he(),[g,w]=H(!1),[T,p]=H([]),[h,R]=H(s.stream),[_,f]=H(s.date),[l,S]=H([]),v=j(null),P=j(!1),u=j(null);z(()=>(u.current=setInterval(()=>{e.flushPendingUpdates()},200),()=>{u.current&&clearInterval(u.current)}),[]);const{data:x,isLoading:k,error:t}=J("streams","/api/streams",{timeout:15e3,retries:2,retryDelay:1e3});z(()=>{if(x&&Array.isArray(x)&&x.length>0&&!P.current){if(console.log("TimelinePage: Streams loaded, initializing data"),P.current=!0,p(x),e.setState({streams:x}),x.some(d=>d.name===h)&&h)console.log("TimelinePage: Using stream from URL: ".concat(h));else if(x.length>0){const d=x[0].name;console.log("TimelinePage: Using first stream: ".concat(d)),R(d)}}},[x]),z(()=>{t&&(console.error("TimelinePage: Error loading streams:",t),F("Error loading streams: "+t.message,"error"))},[t]);const r=y=>{const d=new Date(y);d.setHours(0,0,0,0);const I=new Date(y);I.setHours(23,59,59,999);const U=d.toISOString(),E=I.toISOString();return console.log("TimelinePage: Generated time range:",{date:y,startDate:d.toString(),endDate:I.toString(),startTime:U,endTime:E}),{startTime:U,endTime:E}};z(()=>{h&&(fe(h,_),e.setState({selectedStream:h,selectedDate:_}))},[h,_]);const i=r(_),o=i.startTime,c=i.endTime,a=h?"/api/timeline/segments?stream=".concat(encodeURIComponent(h),"&start=").concat(encodeURIComponent(o),"&end=").concat(encodeURIComponent(c)):null;console.log("TimelinePage: Timeline URL:",a);const{data:b,isLoading:m,error:C,refetch:$}=J(["timeline-segments",h,_],a,{timeout:3e4,retries:2,retryDelay:1e3},{enabled:!!h,onSuccess:y=>{console.log("TimelinePage: Timeline data received:",y);const d=y.segments||[];if(console.log("TimelinePage: Received ".concat(d.length," segments")),d.length===0){console.log("TimelinePage: No segments found"),S([]),e.setState({timelineSegments:[],currentSegmentIndex:-1,currentTime:null,isPlaying:!1}),F("No recordings found for the selected date","warning");return}const I=JSON.parse(JSON.stringify(d));I.slice(0,3).forEach((q,M)=>{const V=new Date(q.start_timestamp*1e3),O=new Date(q.end_timestamp*1e3);console.log("TimelinePage: Segment ".concat(M," - Start: ").concat(V.toLocaleTimeString(),", End: ").concat(O.toLocaleTimeString()))}),console.log("TimelinePage: Setting segments"),S(I),document.body.offsetHeight;const U=I[0].start_timestamp;console.log("TimelinePage: Setting initial segment and time",{firstSegmentId:I[0].id,startTime:new Date(U*1e3).toLocaleTimeString()}),console.log("TimelinePage: Directly setting timelineState properties"),e.timelineSegments=I,e.currentSegmentIndex=0,e.currentTime=U,e.prevCurrentTime=U,e.isPlaying=!1,e.forceReload=!0,e.zoomLevel=1,e.selectedDate=_,e.setState({}),console.log("TimelinePage: Updated timelineState with segments"),setTimeout(()=>{console.log("TimelinePage: State after update (delayed check):",{segmentsLength:e.timelineSegments.length,currentSegmentIndex:e.currentSegmentIndex,currentTime:e.currentTime}),(!e.currentTime||e.currentSegmentIndex===-1)&&(console.log("TimelinePage: State not properly updated, forcing update"),e.setState({currentSegmentIndex:0,currentTime:U,prevCurrentTime:U}))},100);const E=document.querySelector("#video-player video");E&&(E.src="/api/recordings/play/".concat(I[0].id,"?t=").concat(Date.now()),E.load()),F("Loaded ".concat(I.length," recording segments"),"success")},onError:y=>{console.error("TimelinePage: Error loading timeline data:",y),console.error("TimelinePage: Error details:",{message:y.message,status:y.status,statusText:y.statusText,response:y.response}),F("Error loading timeline data: "+y.message,"error"),S([])}}),L=y=>{const d=y.target.value;console.log("TimelinePage: Stream changed to ".concat(d)),R(d)},D=y=>{const d=y.target.value;console.log("TimelinePage: Date changed to ".concat(d)),f(d)},N=()=>m?n(ie,{message:"Loading timeline data..."}):l.length===0?n("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[n("svg",{className:"w-16 h-16 text-gray-400 dark:text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:n("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),n("p",{className:"text-gray-600 dark:text-gray-400 text-lg",children:"No recordings found for the selected date and stream"})]}):n(Z,{children:[n(de,{}),n(se,{}),n("div",{id:"timeline-container",className:"relative w-full h-24 bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg mb-6 overflow-hidden",ref:v,children:[n(le,{}),n(ae,{segments:l}),n(me,{}),n("div",{className:"absolute bottom-1 right-2 text-xs text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 bg-opacity-75 dark:bg-opacity-75 px-2 py-1 rounded",children:"Drag the orange dial to navigate"})]})]});return n("div",{className:"timeline-page",children:[n("div",{className:"flex items-center mb-4",children:[n("h1",{className:"text-2xl font-bold",children:"Timeline Playback"}),n("div",{className:"ml-4 flex",children:[n("a",{href:"recordings.html",className:"px-3 py-1 bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-l-md",children:"Table View"}),n("a",{href:"timeline.html",className:"px-3 py-1 bg-blue-500 text-white rounded-r-md",children:"Timeline View"})]})]}),n("div",{className:"flex flex-wrap gap-4 mb-2",children:[n("div",{className:"stream-selector flex-grow",children:[n("div",{className:"flex justify-between items-center mb-2",children:[n("label",{htmlFor:"stream-selector",children:"Stream"}),n("button",{className:"text-xs bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-2 py-1 rounded",onClick:()=>$(),children:"Reload Data"})]}),n("select",{id:"stream-selector",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white",value:h||"",onChange:L,children:[n("option",{value:"",disabled:!0,children:["Select a stream (",T.length," available)"]}),T.map(y=>n("option",{value:y.name,children:y.name},y.name))]})]}),n("div",{className:"date-selector flex-grow",children:[n("label",{htmlFor:"timeline-date",className:"block mb-2",children:"Date"}),n("input",{type:"date",id:"timeline-date",className:"w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white",value:_,onChange:D})]})]}),n("div",{className:"mb-4 text-sm text-gray-500 dark:text-gray-400 italic",children:m?"Loading...":"Recordings auto-load when stream or date changes"}),n("div",{className:"flex justify-between items-center mb-2",children:n("div",{id:"time-display",className:"timeline-time-display bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded font-mono text-base",children:"00:00:00"})}),n("div",{className:"mb-2 text-xs text-gray-500",children:["Debug - isLoading: ",m?"true":"false",", Streams: ",T.length,", Segments: ",l.length]}),N(),n("div",{className:"mt-6 p-4 bg-gray-200 dark:bg-gray-800 rounded",children:[n("h3",{className:"text-lg font-semibold mb-2",children:"How to use the timeline:"}),n("ul",{className:"list-disc pl-5",children:[n("li",{children:"Select a stream and date to load recordings"}),n("li",{children:"Click on the timeline to position the cursor at a specific time"}),n("li",{children:"Drag the orange cursor to navigate precisely"}),n("li",{children:"Click on a segment (blue bar) to play that recording"}),n("li",{children:"Use the play button to start playback from the current cursor position"}),n("li",{children:"Use the zoom buttons to adjust the timeline scale"})]})]})]})}document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("main-content");s&&K(n(ne,{client:ee,children:[n(re,{}),n(te,{}),n(Te,{}),n(oe,{})]}),s)});export{ye as __vite_legacy_guard};
//# sourceMappingURL=timeline-CizL5nza.js.map
