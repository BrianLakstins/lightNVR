System.register(["./query-client-legacy-BljCN6fF.js","./layout-legacy-BJPDh9kM.js","./LiveView-legacy-DHrW1Ba3.js","./UI-legacy-BRvu-Wy1.js","./LoadingIndicator-legacy-D9Q5iI8j.js","./Footer-legacy-_27R7tN7.js"],(function(e,r){"use strict";var t,n,o,a,s,l,i,c,d,u,g,m,h,p,f,b,y,x,v,w,k,C,N,S,I,R,T,j;return{setters:[e=>{t=e.d,n=e.A,o=e.y,a=e.u,s=e.a,l=e.b,i=e.s,c=e.q,d=e.T,u=e.E,g=e.c,m=e.e,h=e.Q,p=e.k},null,e=>{f=e.D,b=e.t,y=e.u,x=e.F,v=e.L},e=>{w=e.S,k=e.s,C=e.u,N=e.a,S=e.b,I=e.c},e=>{R=e.L},e=>{T=e.H,j=e.F}],execute:function(){function e({stream:e,streamId:r,onToggleFullscreen:s}){const[l,i]=t(!0),[c,d]=t(null),[u,g]=t(!1),m=n(null),h=n(null),p=n(null),y=n(null),x=n(null);return o((()=>{if(!e||!e.name||!m.current)return;console.log(`Initializing WebRTC connection for stream ${e.name}`),i(!0),d(null);const r=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});return p.current=r,r.ontrack=r=>{if(console.log(`Track received for stream ${e.name}`),"video"===r.track.kind){const t=m.current;if(!t)return;t.srcObject=r.streams[0],t.onloadeddata=()=>{console.log(`Video data loaded for stream ${e.name}`)},t.onplaying=()=>{console.log(`Video playing for stream ${e.name}`),i(!1),g(!0)},t.onerror=r=>{console.error(`Video error for stream ${e.name}:`,r),d("Video playback error"),i(!1)}}},r.onicecandidate=r=>{r.candidate&&(""!==r.candidate.candidate?console.log(`ICE candidate for stream ${e.name}`):console.log(`Ignoring empty ICE candidate for stream ${e.name}`))},r.oniceconnectionstatechange=()=>{console.log(`ICE connection state for stream ${e.name}: ${r.iceConnectionState}`),"failed"===r.iceConnectionState&&(d("WebRTC ICE connection failed"),i(!1))},r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"}),r.createOffer().then((e=>r.setLocalDescription(e))).then((()=>{x.current=new AbortController;const t={type:r.localDescription.type,sdp:r.localDescription.sdp},n=localStorage.getItem("auth");return fetch(`/api/webrtc?src=${encodeURIComponent(e.name)}`,{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:"Basic "+n}:{}},body:JSON.stringify(t),signal:x.current.signal})})).then((e=>{if(!e.ok)throw new Error(`Failed to send offer: ${e.status} ${e.statusText}`);return e.text()})).then((r=>{try{return JSON.parse(r)}catch(t){throw console.error(`Error parsing JSON for stream ${e.name}:`,t),new Error("Failed to parse WebRTC answer")}})).then((e=>r.setRemoteDescription(new RTCSessionDescription(e)))).catch((r=>{console.error(`Error setting up WebRTC for stream ${e.name}:`,r),d(r.message||"Failed to establish WebRTC connection"),i(!1)})),()=>{console.log(`Cleaning up WebRTC connection for stream ${e.name}`),x.current&&(x.current.abort(),x.current=null),m.current&&m.current.srcObject&&(m.current.srcObject.getTracks().forEach((e=>e.stop())),m.current.srcObject=null),p.current&&(p.current.close(),p.current=null)}}),[e]),a("div",{className:"video-cell","data-stream-name":e.name,"data-stream-id":r,ref:h,style:{position:"relative",pointerEvents:"auto",zIndex:1},children:[a("video",{id:`video-${r.replace(/\s+/g,"-")}`,className:"video-element",ref:m,playsInline:!0,autoPlay:!0,muted:!0,disablePictureInPicture:!0,style:{width:"100%",height:"100%",objectFit:"contain"}}),e.detection_based_recording&&e.detection_model&&a(f,{ref:y,streamName:e.name,videoRef:m,enabled:u,detectionModel:e.detection_model}),a("div",{className:"stream-name-overlay",style:{position:"absolute",top:"10px",left:"10px",padding:"5px 10px",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"white",borderRadius:"4px",fontSize:"14px",zIndex:3},children:e.name}),a("div",{className:"stream-controls",style:{position:"absolute",bottom:"10px",right:"10px",display:"flex",gap:"10px",zIndex:5,backgroundColor:"rgba(0, 0, 0, 0.5)",padding:"5px",borderRadius:"4px"},children:[a("div",{style:{backgroundColor:"transparent",padding:"5px",borderRadius:"4px"},onMouseOver:e=>e.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.2)",onMouseOut:e=>e.currentTarget.style.backgroundColor="transparent",children:a(w,{streamId:r,streamName:e.name,onSnapshot:()=>{if(m.current){let r=null;if(y.current&&"function"==typeof y.current.getCanvasRef&&(r=y.current.getCanvasRef()),r){const t=b(m,r,e.name);t&&k(t.canvas.toDataURL("image/jpeg",.95),`Snapshot: ${e.name}`)}else{const r=m.current,t=document.createElement("canvas");t.width=r.videoWidth,t.height=r.videoHeight,t.width>0&&t.height>0&&(t.getContext("2d").drawImage(r,0,0,t.width,t.height),k(t.toDataURL("image/jpeg",.95),`Snapshot: ${e.name}`))}}}})}),a("button",{className:"fullscreen-btn",title:"Toggle Fullscreen","data-id":r,"data-name":e.name,onClick:r=>s(e.name,r,h.current),style:{backgroundColor:"transparent",border:"none",padding:"5px",borderRadius:"4px",color:"white",cursor:"pointer"},onMouseOver:e=>e.currentTarget.style.backgroundColor="rgba(255, 255, 255, 0.2)",onMouseOut:e=>e.currentTarget.style.backgroundColor="transparent",children:a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"white","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",children:a("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})]}),l&&a("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:5,pointerEvents:"none"},children:a(R,{message:"Connecting..."})}),c&&a("div",{className:"error-indicator",style:{position:"absolute",top:0,left:0,right:0,bottom:0,width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",color:"white",zIndex:5,textAlign:"center"},children:a("div",{className:"error-content",style:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"80%",maxWidth:"300px",padding:"20px",borderRadius:"8px",backgroundColor:"rgba(0, 0, 0, 0.5)"},children:[a("div",{className:"error-icon",style:{fontSize:"28px",marginBottom:"15px",fontWeight:"bold",width:"40px",height:"40px",lineHeight:"40px",borderRadius:"50%",backgroundColor:"rgba(220, 38, 38, 0.8)",textAlign:"center"},children:"!"}),a("p",{style:{marginBottom:"20px",textAlign:"center",width:"100%",fontSize:"14px",lineHeight:"1.4"},children:c}),a("button",{className:"retry-button",onClick:()=>{d(null),i(!0),p.current&&(p.current.close(),p.current=null),m.current&&m.current.srcObject&&(m.current.srcObject.getTracks().forEach((e=>e.stop())),m.current.srcObject=null),g(!1)},style:{padding:"8px 20px",backgroundColor:"#2563eb",color:"white",borderRadius:"4px",border:"none",cursor:"pointer",fontWeight:"bold",fontSize:"14px",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.2)",transition:"background-color 0.2s ease"},onMouseOver:e=>e.currentTarget.style.backgroundColor="#1d4ed8",onMouseOut:e=>e.currentTarget.style.backgroundColor="#2563eb",children:"Retry"})]})})]})}function r(){const{takeSnapshot:r}=C(),{isFullscreen:n,setIsFullscreen:u,toggleFullscreen:g}=y(),[m,h]=t([]),[p,f]=t(!0),[b,v]=t((()=>{const e=new URLSearchParams(window.location.search).get("layout");return e||(sessionStorage.getItem("webrtc_layout")||"4")})),[w,k]=t((()=>{const e=new URLSearchParams(window.location.search).get("stream");return e||(sessionStorage.getItem("webrtc_selected_stream")||"")})),[R,T]=t((()=>{const e=new URLSearchParams(window.location.search).get("page");if(e)return Math.max(0,parseInt(e,10)-1);const r=sessionStorage.getItem("webrtc_current_page");return r?Math.max(0,parseInt(r,10)-1):0})),j=s();o((()=>{N(),S()}),[]);const{data:E,isLoading:$,error:L}=l("streams","/api/streams",{timeout:15e3,retries:2,retryDelay:1e3});o((()=>{f($)}),[$]),o((()=>{E&&Array.isArray(E)&&(async()=>{try{const e=await F(E);if(e.length>0){h(e);const r=new URLSearchParams(window.location.search).get("stream");r&&e.some((e=>e.name===r))?k(r):w&&e.some((e=>e.name===w))||k(e[0].name)}else console.warn("No streams available for WebRTC view after filtering")}catch(e){console.error("Error processing streams:",e),i("Error processing streams: "+e.message)}})()}),[E,w]),o((()=>{if(0===m.length)return;console.log("Updating URL parameters");const e=new URL(window.location);0===R?e.searchParams.delete("page"):e.searchParams.set("page",R+1),"4"!==b?e.searchParams.set("layout",b):e.searchParams.delete("layout"),"1"===b&&w?e.searchParams.set("stream",w):e.searchParams.delete("stream"),window.history.replaceState({},"",e),R>0?sessionStorage.setItem("webrtc_current_page",(R+1).toString()):sessionStorage.removeItem("webrtc_current_page"),"4"!==b?sessionStorage.setItem("webrtc_layout",b):sessionStorage.removeItem("webrtc_layout"),"1"===b&&w?sessionStorage.setItem("webrtc_selected_stream",w):sessionStorage.removeItem("webrtc_selected_stream")}),[R,b,w,m.length]);const F=async e=>{try{if(!e||!Array.isArray(e))return console.warn("No streams data provided to filter"),[];const r=e.map((async e=>{try{const r=e.id||e.name;return await j.fetchQuery({queryKey:["stream-details",r],queryFn:async()=>{const t=await fetch(`/api/streams/${encodeURIComponent(r)}`);if(!t.ok)throw new Error(`Failed to load details for stream ${e.name}`);return t.json()},staleTime:3e4})}catch(r){return console.error(`Error loading details for stream ${e.name}:`,r),e}})),t=await Promise.all(r);console.log("Loaded detailed streams for WebRTC view:",t);const n=t.filter((e=>e.is_deleted?(console.log(`Stream ${e.name} is soft deleted, filtering out`),!1):e.enabled?!!e.streaming_enabled||(console.log(`Stream ${e.name} is not configured for streaming, filtering out`),!1):(console.log(`Stream ${e.name} is inactive, filtering out`),!1)));return console.log("Filtered streams for WebRTC view:",n),n||[]}catch(r){return console.error("Error filtering streams for WebRTC view:",r),i("Error processing streams: "+r.message),[]}},M=c((()=>{switch(b){case"1":return 1;case"2":return 2;case"4":default:return 4;case"6":return 6;case"9":return 9;case"16":return 16}}),[b]),_=c((()=>{let e=m;if("1"===b&&w)e=m.filter((e=>e.name===w));else{const r=M(),t=Math.ceil(m.length/r);if(R>=t&&t>0)return[];const n=R*r,o=Math.min(n+r,m.length);e=m.slice(n,o)}return e}),[m,b,w,R]);o((()=>{if(0===m.length)return;const e=M(),r=Math.ceil(m.length/e);R>=r&&T(Math.max(0,r-1))}),[m,b,R,M]);const W=(e,r,t)=>{r&&(r.preventDefault(),r.stopPropagation()),e?(console.log(`Toggling fullscreen for stream: ${e}`),t?document.fullscreenElement?(console.log("Exiting fullscreen mode"),document.exitFullscreen()):(console.log("Entering fullscreen mode for video cell"),t.requestFullscreen().catch((e=>{console.error(`Error attempting to enable fullscreen: ${e.message}`),i(`Could not enable fullscreen mode: ${e.message}`)}))):console.error("Video cell element not provided for fullscreen toggle")):console.error("Stream name not provided for fullscreen toggle")},O=d((()=>_()),[m,b,w,R,M]);return a("section",{id:"live-page",className:"page "+(n?"fullscreen-mode":""),children:[a(I,{}),a(x,{isFullscreen:n,setIsFullscreen:u,targetId:"live-page"}),a("div",{className:"page-header flex justify-between items-center mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow",style:{position:"relative",zIndex:10,pointerEvents:"auto"},children:[a("div",{className:"flex items-center space-x-2",children:[a("h2",{className:"text-xl font-bold mr-4",children:"Live View"}),a("div",{className:"flex space-x-2",children:a("button",{id:"hls-toggle-btn",className:"px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 inline-block text-center",style:{position:"relative",zIndex:50},onClick:()=>{window.location.href="/hls.html"},children:"HLS View"})})]}),a("div",{className:"controls flex items-center space-x-2",children:[a("div",{className:"flex items-center",children:[a("label",{htmlFor:"layout-selector",className:"mr-2",children:"Layout:"}),a("select",{id:"layout-selector",className:"px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600",value:b,onChange:e=>{const r=e.target.value;v(r),T(0)},children:[a("option",{value:"1",children:"1 Stream"}),a("option",{value:"2",children:"2 Streams"}),a("option",{value:"4",children:"4 Streams"}),a("option",{value:"6",children:"6 Streams"}),a("option",{value:"9",children:"9 Streams"}),a("option",{value:"16",children:"16 Streams"})]})]}),"1"===b&&a("div",{className:"flex items-center",children:[a("label",{htmlFor:"stream-selector",className:"mr-2",children:"Stream:"}),a("select",{id:"stream-selector",className:"px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600",value:w,onChange:e=>{const r=e.target.value;k(r)},children:m.map((e=>a("option",{value:e.name,children:e.name},e.name)))})]}),a("button",{id:"fullscreen-btn",className:"p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 focus:outline-none",onClick:()=>g(),title:"Toggle Fullscreen",children:a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})]})]}),a("div",{className:"flex flex-col space-y-4 h-full",children:[a("div",{id:"video-grid",className:`video-container layout-${b}`,children:$?a("div",{className:"flex justify-center items-center col-span-full row-span-full h-64 w-full",style:{pointerEvents:"none",zIndex:1},children:a("div",{className:"flex flex-col items-center justify-center py-8",children:[a("div",{className:"inline-block animate-spin rounded-full border-4 border-gray-300 dark:border-gray-600 border-t-blue-600 dark:border-t-blue-500 w-16 h-16"}),a("p",{className:"mt-4 text-gray-700 dark:text-gray-300",children:"Loading streams..."})]})}):p&&!$?a("div",{className:"flex justify-center items-center col-span-full row-span-full h-64 w-full",style:{pointerEvents:"none",position:"relative",zIndex:1},children:a("div",{className:"flex flex-col items-center justify-center py-8",children:[a("div",{className:"inline-block animate-spin rounded-full border-4 border-gray-300 dark:border-gray-600 border-t-blue-600 dark:border-t-blue-500 w-16 h-16"}),a("p",{className:"mt-4 text-gray-700 dark:text-gray-300",children:"Loading streams..."})]})}):L?a("div",{className:"placeholder flex flex-col justify-center items-center col-span-full row-span-full bg-white dark:bg-gray-800 rounded-lg shadow-md text-center p-8",children:[a("p",{className:"mb-6 text-gray-600 dark:text-gray-300 text-lg",children:["Error loading streams: ",L.message]}),a("button",{onClick:()=>window.location.reload(),className:"btn-primary px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Retry"})]}):0===m.length?a("div",{className:"placeholder flex flex-col justify-center items-center col-span-full row-span-full bg-white dark:bg-gray-800 rounded-lg shadow-md text-center p-8",children:[a("p",{className:"mb-6 text-gray-600 dark:text-gray-300 text-lg",children:"No streams configured"}),a("a",{href:"streams.html",className:"btn-primary px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Configure Streams"})]}):O.map((r=>a(e,{stream:r,onToggleFullscreen:W,streamId:r.name},r.name)))}),"1"!==b&&m.length>M()?a("div",{className:"pagination-controls flex justify-center items-center space-x-4 mt-4",children:[a("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>{console.log("Changing to previous page"),T(Math.max(0,R-1))},disabled:0===R,children:"Previous"}),a("span",{className:"text-gray-700 dark:text-gray-300",children:["Page ",R+1," of ",Math.ceil(m.length/M())]}),a("button",{className:"px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed",onClick:()=>{console.log("Changing to next page");const e=Math.ceil(m.length/M());T(Math.min(e-1,R+1))},disabled:R>=Math.ceil(m.length/M())-1,children:"Next"})]}):null]})]})}function E(){const[e,n]=t(!1),[s,l]=t(!0);return o((()=>{!async function(){try{const e=await fetch("/api/settings");if(!e.ok)return console.error("Failed to fetch settings:",e.status,e.statusText),void l(!1);(await e.json()).webrtc_disabled?(console.log("WebRTC is disabled, using HLS view"),n(!0)):(console.log("WebRTC is enabled, using WebRTC view"),n(!1))}catch(e){console.error("Error checking WebRTC status:",e)}finally{l(!1)}}()}),[]),s?a("div",{className:"loading",children:"Loading..."}):a(p,{children:e?a(v,{isWebRTCDisabled:!0}):a(r,{})})}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("main-content");e&&u(a(h,{client:g,children:[a(T,{}),a(m,{}),a(E,{}),a(j,{})]}),e)}))}}}));
//# sourceMappingURL=index-legacy-B8q18AEo.js.map
