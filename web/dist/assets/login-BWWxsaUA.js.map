{"version":3,"file":"login-BWWxsaUA.js","sources":["../../js/components/preact/LoginView.jsx","../../js/pages/login-page.jsx"],"sourcesContent":["/**\n * LightNVR Web Interface LoginView Component\n * Preact component for the login page\n */\n\nimport { useState, useRef, useEffect } from 'preact/hooks';\n\n/**\n * LoginView component\n * @returns {JSX.Element} LoginView component\n */\nexport function LoginView() {\n  const [username, setUsername] = useState('');\n  const [password, setPassword] = useState('');\n  const [isLoggingIn, setIsLoggingIn] = useState(false);\n  const [errorMessage, setErrorMessage] = useState('');\n  const redirectTimerRef = useRef(null);\n\n  // Check URL for error, auth_required, or logout parameter\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.has('error')) {\n      setErrorMessage('Invalid username or password');\n    } else if (urlParams.has('auth_required') && urlParams.has('logout')) {\n      setErrorMessage('You have been successfully logged out.');\n    } else if (urlParams.has('auth_required')) {\n      setErrorMessage('Authentication required. Please log in to continue.');\n    } else if (urlParams.has('logout')) {\n      setErrorMessage('You have been successfully logged out.');\n    }\n  }, []);\n\n  // Request controller for cancelling requests\n  const requestControllerRef = useRef(null);\n\n  // Cleanup function for any timers\n  useEffect(() => {\n    return () => {\n      if (redirectTimerRef.current) {\n        clearTimeout(redirectTimerRef.current);\n      }\n    };\n  }, []);\n\n  // Function to check if browser might be blocking redirects\n  const checkBrowserRedirectSupport = () => {\n    // Check if running in a sandboxed iframe which might block navigation\n    const isSandboxed = window !== window.top;\n\n    // Check if there are any service workers that might intercept navigation\n    const hasServiceWorker = 'serviceWorker' in navigator;\n\n    // Log potential issues\n    if (isSandboxed) {\n      console.warn('Login page is running in an iframe, which might block navigation');\n    }\n\n    if (hasServiceWorker) {\n      console.log('Service Worker API is available, checking for active service workers');\n      navigator.serviceWorker.getRegistrations().then(registrations => {\n        if (registrations.length > 0) {\n          console.warn(`${registrations.length} service worker(s) detected which might intercept navigation`);\n        } else {\n          console.log('No active service workers detected');\n        }\n      });\n    }\n\n    return { isSandboxed, hasServiceWorker };\n  };\n\n  // Handle login form submission\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n\n    if (!username || !password) {\n      setErrorMessage('Please enter both username and password');\n      return;\n    }\n\n    setIsLoggingIn(true);\n    setErrorMessage('');\n\n    try {\n      // Store credentials in localStorage for future requests\n      const authString = btoa(`${username}:${password}`);\n      localStorage.setItem('auth', authString);\n\n      // Make login request\n      const response = await fetch('/api/auth/login', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Basic ${authString}`\n        },\n        body: JSON.stringify({ username, password }),\n        timeout: 10000\n      });\n\n      if (response.ok) {\n        // Successful login\n        console.log('Login successful, proceeding to redirect');\n\n        // Try multiple redirect approaches\n        try {\n          // Get redirect URL from query parameter if it exists\n          const urlParams = new URLSearchParams(window.location.search);\n          const redirectUrl = urlParams.get('redirect');\n\n          // Add timestamp to prevent caching issues\n          const targetUrl = redirectUrl\n              ? redirectUrl\n              : `/index.html`;\n\n\n          // Set a fallback timer in case the redirect doesn't happen immediately\n          redirectTimerRef.current = setTimeout(() => {\n            console.log('Fallback: trying window.location.href');\n            window.location.href = targetUrl;\n\n            // If that also doesn't work, try replace\n            redirectTimerRef.current = setTimeout(() => {\n              console.log('Fallback: trying window.location.replace');\n              window.location.replace(targetUrl);\n            }, 500);\n          }, 500);\n        } catch (redirectError) {\n          console.error('Redirect error:', redirectError);\n          // Last resort: try a different approach\n          window.location.replace('index.html');\n        }\n      } else {\n        // Failed login\n        setIsLoggingIn(false);\n        setErrorMessage('Invalid username or password');\n        localStorage.removeItem('auth');\n      }\n    } catch (error) {\n      console.error('Login error:', error);\n      // Reset login state on error\n      setIsLoggingIn(false);\n      setErrorMessage('An error occurred during login. Please try again.');\n      localStorage.removeItem('auth');\n    }\n  };\n\n  // Determine error message class based on content\n  const getErrorMessageClass = () => {\n    const baseClass = \"mb-4 p-3 rounded-lg \";\n\n    // Check for success messages\n    const isSuccess = (\n      errorMessage.includes('successfully logged out') ||\n      errorMessage.includes('Click the button below') ||\n      errorMessage.includes('Login successful')\n    );\n\n    return baseClass + (\n      isSuccess\n        ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200'\n        : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200'\n    );\n  };\n\n  return (\n    <section id=\"login-page\" className=\"page flex items-center justify-center min-h-screen\">\n      <div className=\"login-container w-full max-w-md p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-2xl font-bold\">LightNVR</h1>\n          <p className=\"text-gray-600 dark:text-gray-400\">Please sign in to continue</p>\n        </div>\n\n        {errorMessage && (\n          <div className={getErrorMessageClass()}>\n            {errorMessage}\n          </div>\n        )}\n\n        <form id=\"login-form\" className=\"space-y-6\" action=\"/api/auth/login\" method=\"POST\" onSubmit={handleSubmit}>\n          <div className=\"form-group\">\n            <label htmlFor=\"username\" className=\"block text-sm font-medium mb-1\">Username</label>\n            <input\n                type=\"text\"\n                id=\"username\"\n                name=\"username\"\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white\"\n                placeholder=\"Enter your username\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                required\n                autoComplete=\"username\"\n            />\n          </div>\n          <div className=\"form-group\">\n            <label htmlFor=\"password\" className=\"block text-sm font-medium mb-1\">Password</label>\n            <input\n                type=\"password\"\n                id=\"password\"\n                name=\"password\"\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                autoComplete=\"current-password\"\n            />\n          </div>\n          <div className=\"form-group\">\n            <button\n                type=\"submit\"\n                className=\"w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed\"\n                disabled={isLoggingIn}\n            >\n              {isLoggingIn ? 'Signing in...' : 'Sign In'}\n            </button>\n          </div>\n        </form>\n\n        <div className=\"mt-6 text-center text-sm text-gray-600 dark:text-gray-400\">\n          <p>Default credentials: admin / admin</p>\n          <p className=\"mt-2\">You can change these in Settings after login</p>\n        </div>\n      </div>\n    </section>\n  );\n}\n","/**\n * LightNVR Web Interface Login Page\n * Entry point for the login page\n */\n\nimport { render } from 'preact';\nimport { LoginView } from '../components/preact/LoginView.jsx';\nimport { QueryClientProvider, queryClient } from '../query-client.js';\nimport { ToastContainer } from \"../components/preact/ToastContainer.jsx\";\n\n// Render the LoginView component when the DOM is loaded\ndocument.addEventListener('DOMContentLoaded', () => {\n  // Get the container element\n  const container = document.getElementById('main-content');\n\n  if (container) {\n    // Render the LoginView component\n    render(\n      <QueryClientProvider client={queryClient}>\n        <ToastContainer />\n        <LoginView />\n      </QueryClientProvider>,\n      container\n    );\n  }\n});\n"],"names":["LoginView","username","setUsername","useState","password","setPassword","isLoggingIn","setIsLoggingIn","errorMessage","setErrorMessage","redirectTimerRef","useRef","useEffect","urlParams","handleSubmit","e","authString","redirectUrl","targetUrl","redirectError","error","jsx","jsxs","baseClass","isSuccess","container","render","QueryClientProvider","queryClient","ToastContainer"],"mappings":"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"}