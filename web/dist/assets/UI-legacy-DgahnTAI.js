System.register(["./query-client-legacy-_zrrCFf8.js"],(function(e,t){"use strict";var o,n,r,a,d,l,i,s;return{setters:[e=>{o=e.d,n=e.q,r=e.y,a=e.s,d=e.u,l=e.K,i=e.A,s=e.$}],execute:function(){e({D:function(e){const{isOpen:t,onClose:o,onConfirm:n,mode:r,count:a}=e;if(!t)return null;let l="Confirm Delete",i="Are you sure you want to delete this item?";return"selected"===r?(l="Delete Selected Recordings",i=`Are you sure you want to delete ${a} selected recording${1!==a?"s":""}?`):"all"===r&&(l="Delete All Filtered Recordings",i="Are you sure you want to delete all recordings matching the current filters? This action cannot be undone."),d("div",{class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&o()},onKeyDown:e=>{"Escape"===e.key&&o()},children:d("div",{class:"bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-md mx-auto",children:[d("div",{class:"mb-4",children:d("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white",children:l})}),d("p",{class:"text-gray-600 dark:text-gray-300 mb-6",children:i}),d("div",{class:"flex justify-end space-x-3",children:[d("button",{class:"px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600",onClick:o,children:"Cancel"}),d("button",{class:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors",onClick:n,children:"Delete"})]})]})})},S:u,a:function(){console.warn("setupModals() is deprecated. Use <ModalProvider> component instead.")},b:function(){console.warn("addModalStyles() is deprecated. Modal styles are now included in components.css")},c:h,d:function(e,o,n){if(console.warn("Direct showVideoModal() is deprecated. Use ModalContext.showVideoModal instead."),window.__modalContext&&window.__modalContext.showVideoModal)return console.log("Using modal context to show video modal"),void window.__modalContext.showVideoModal(e,o,n);if(console.log("Falling back to direct modal rendering"),!document.getElementById("modal-root")){console.log("Creating modal root element");const e=document.createElement("div");e.id="modal-root",document.body.appendChild(e)}const r=document.createElement("div");r.id="temp-modal-container",document.body.appendChild(r),console.log("Dynamically importing preact to render modal"),c((async()=>{const{render:e,h:o}=await t.import("./query-client-legacy-_zrrCFf8.js").then((e=>e.p));return{render:e,h:o}}),void 0,t.meta.url).then((({render:t,h:a})=>{console.log("Rendering VideoModal component"),t(a(y,{isOpen:!0,onClose:()=>{console.log("Closing modal"),t(null,r),document.body.removeChild(r)},videoUrl:e,title:o,downloadUrl:n}),r)})).catch((e=>{console.error("Error rendering video modal:",e),a("Error showing video modal: "+e.message,"error")}))},e:function({children:e}){const[t,r]=o({isOpen:!1,imageData:"",streamName:""}),[l,i]=o({isOpen:!1,videoUrl:"",title:"",downloadUrl:""}),s=n(((e,t)=>{r({isOpen:!0,imageData:e,streamName:t})}),[]),c=n(((e,t,o)=>{console.log("ModalProvider.showVideoModal called with:",{videoUrl:e,title:t,downloadUrl:o}),i({isOpen:!1,videoUrl:"",title:"",downloadUrl:""}),setTimeout((()=>{i({isOpen:!0,videoUrl:e,title:t,downloadUrl:o}),console.log("Video modal state updated with new content")}),50)}),[]),{downloadSnapshot:h}=m(),u=n((()=>{try{const{imageData:e,streamName:o}=t;if(!e)return console.error("No image data available for download"),void a("Download failed: No image data available","error",5e3);if(h)return void h();const n=`snapshot_${o}_${(new Date).toISOString().replace(/[:.]/g,"-")}.jpg`,r=document.createElement("a");r.href=e,r.download=n,document.body.appendChild(r),r.click(),setTimeout((()=>{document.body.removeChild(r)}),100),a("Snapshot downloaded successfully","success",3e3)}catch(e){console.error("Error in snapshot download process:",e),a("Download failed: "+e.message,"error",5e3)}}),[t,h]),g=n((()=>{r((e=>({...e,isOpen:!1})))}),[]),v=n((()=>{console.log("Closing video modal"),i((e=>({...e,isOpen:!1}))),setTimeout((()=>{i({isOpen:!1,videoUrl:"",title:"",downloadUrl:""}),console.log("Video modal state fully reset")}),300)}),[]),f={showSnapshotPreview:s,showVideoModal:c};return d(p.Provider,{value:f,children:[e,d(w,{isOpen:t.isOpen,onClose:g,imageData:t.imageData,streamName:t.streamName,onDownload:u}),d(y,{isOpen:l.isOpen,onClose:v,videoUrl:l.videoUrl,title:l.title,downloadUrl:l.downloadUrl})]})},s:v,u:m});const c=function(e,t,o){let n=Promise.resolve();function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then((t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)}))};function m(){const[e,t]=o({canvas:null,fileName:null});return{takeSnapshot:n(((e,o)=>{console.log(`Taking snapshot of stream with ID: ${e}`);const n=document.querySelector(`.snapshot-btn[data-id="${e}"]`);let r;if(n)r=n.getAttribute("data-name");else if(o){const e=o.currentTarget||o.target,t=e?e.closest(".video-cell"):null;t&&(r=t.dataset.streamName)}if(!r)return console.error("Stream name not found for ID:",e),void a("Cannot take snapshot: Stream not identified","error");const d=`video-${r.replace(/\s+/g,"-")}`,l=document.getElementById(d);if(!l)return void console.error("Video element not found for stream:",r);const i=document.createElement("canvas");if(i.width=l.videoWidth,i.height=l.videoHeight,0===i.width||0===i.height)return console.error("Invalid video dimensions:",i.width,i.height),void a("Cannot take snapshot: Video not loaded or has invalid dimensions");i.getContext("2d").drawImage(l,0,0,i.width,i.height);try{const e=(new Date).toISOString().replace(/[:.]/g,"-"),o=`snapshot-${r.replace(/\s+/g,"-")}-${e}.jpg`;t({canvas:i,fileName:o}),v(i.toDataURL("image/jpeg",.95),`Snapshot: ${r}`),a("Snapshot taken successfully")}catch(s){console.error("Error creating snapshot:",s),a("Failed to create snapshot: "+s.message)}}),[]),downloadSnapshot:n((()=>{const{canvas:t,fileName:o}=e;if(!t)return console.error("No snapshot canvas available"),void a("Download failed: No snapshot data available");t.toBlob((function(e){if(!e)return console.error("Failed to create blob from canvas"),void a("Download failed: Unable to create image data");console.log("Created blob:",e.size,"bytes");const t=URL.createObjectURL(e);console.log("Created blob URL:",t);const n=document.createElement("a");n.href=t,n.download=o||"snapshot.jpg",document.body.appendChild(n),console.log("Added download link to document"),n.click(),setTimeout((()=>{document.body.contains(n)&&document.body.removeChild(n),URL.revokeObjectURL(t),console.log("Cleaned up download resources")}),1e3),a("Download started")}),"image/jpeg",.95)}),[e]),hasSnapshot:!!e.canvas}}function h(){const{takeSnapshot:e,downloadSnapshot:t}=m();return r((()=>(window.takeSnapshot=e,()=>{delete window.takeSnapshot})),[e]),null}function u({streamId:e,streamName:t,onSnapshot:o}){const{takeSnapshot:n}=m();return d("button",{className:"snapshot-btn",title:"Take Snapshot","data-id":e,"data-name":t,onClick:t=>{t.preventDefault(),t.stopPropagation(),"function"==typeof o?o(t):n(e,t)},children:d("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"white","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",children:[d("path",{d:"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"}),d("circle",{cx:"12",cy:"13",r:"4"})]})})}const g=Object.freeze(Object.defineProperty({__proto__:null,SnapshotButton:u,SnapshotManager:h,useSnapshotManager:m},Symbol.toStringTag,{value:"Module"})),p=e("M",l({showVideoModal:()=>{},showSnapshotPreview:()=>{}}));function w({isOpen:e,onClose:t,imageData:o,streamName:n,onDownload:a}){const l=i(null);return r((()=>{const o=o=>{"Escape"===o.key&&e&&t()};return document.addEventListener("keydown",o),e&&l.current&&setTimeout((()=>{const e=l.current.querySelector(".modal-content");e&&(e.classList.remove("scale-95","opacity-0"),e.classList.add("scale-100","opacity-100"))}),10),()=>{document.removeEventListener("keydown",o)}}),[e,t]),e?s(d("div",{ref:l,id:"snapshot-preview-modal",className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&t()},children:d("div",{className:"modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-out scale-95 opacity-0",style:{width:"90%"},children:[d("div",{className:"flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700",children:[d("h3",{id:"snapshot-preview-title",className:"text-lg font-semibold text-gray-900 dark:text-white",children:n?`Snapshot: ${n}`:"Snapshot"}),d("button",{className:"close text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",onClick:t,children:"âœ•"})]}),d("div",{className:"p-4 overflow-auto flex-grow",children:d("img",{id:"snapshot-preview-image",className:"max-w-full max-h-[70vh] mx-auto",src:o,alt:"Snapshot"})}),d("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2",children:[d("button",{id:"snapshot-download-btn",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",onClick:a,children:"Download"}),d("button",{id:"snapshot-close-btn",className:"px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600",onClick:t,children:"Close"})]})]})}),document.body):null}function y({isOpen:e,onClose:t,videoUrl:l,title:c,downloadUrl:m}){console.log("VideoModal rendered with props:",{isOpen:e,videoUrl:l,title:c});const[h,u]=o(!1),[g,p]=o(2),[w,y]=o([]),[v,f]=o(null),[b,x]=o("No detections loaded"),[k,N]=o(1),S=i(null),C=i(null),D=i(null);r((()=>{const o=o=>{"Escape"===o.key&&e&&t()};return e&&(console.log("VideoModal opened, setting up event listeners"),document.addEventListener("keydown",o),S.current&&S.current.load()),()=>{if(console.log("VideoModal cleanup"),document.removeEventListener("keydown",o),S.current)try{S.current.pause(),S.current.removeAttribute("src"),S.current.load()}catch(e){console.error("Error cleaning up video element:",e)}}}),[e,t]),r((()=>{if(!e||!l)return;const t=l.match(/\/play\/(\d+)/);if(!t||!t[1])return;const o=parseInt(t[1],10);(async()=>{try{const e=await fetch(`/api/recordings/${o}`);if(!e.ok)throw new Error("Failed to fetch recording data");const t=await e.json();if(f(t),t&&t.stream&&t.start_time&&t.end_time){const e=Math.floor(new Date(t.start_time).getTime()/1e3),o=Math.floor(new Date(t.end_time).getTime()/1e3),n=await fetch(`/api/detection/results/${t.stream}?start=${e}&end=${o}`);if(!n.ok)throw new Error("Failed to fetch detections");const r=(await n.json()).detections||[];y(r),r.length>0?x(`${r.length} detection${1!==r.length?"s":""} available`):x("No detections found for this recording")}}catch(e){console.error("Error fetching data:",e),x("Error loading detections")}})()}),[e,l]);const E=n((()=>{if(!h||!S.current||!C.current||0===w.length)return;const e=S.current,t=C.current,o=e.videoWidth,n=e.videoHeight;if(0===o||0===n)return void requestAnimationFrame(E);t.width=o,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const a=e.currentTime;if(!v||!v.start_time)return;const d=Math.floor(new Date(v.start_time).getTime()/1e3)+Math.floor(a),l=w.filter((e=>!!e.timestamp&&Math.abs(e.timestamp-d)<=g));l.length>0?x(`Showing ${l.length} detection${1!==l.length?"s":""} at current time`):x(`No detections at current time (${w.length} total)`),l.forEach((e=>{const t=e.x*o,a=e.y*n,d=e.width*o,l=e.height*n;r.strokeStyle="rgba(0, 255, 0, 0.8)",r.lineWidth=2,r.strokeRect(t,a,d,l),r.fillStyle="rgba(0, 0, 0, 0.7)";const i=`${e.label} (${Math.round(100*e.confidence)}%)`,s=r.measureText(i).width+10;r.fillRect(t,a-20,s,20),r.fillStyle="white",r.font="12px Arial",r.fillText(i,t+5,a-5)})),e.paused||e.ended||requestAnimationFrame(E)}),[h,w,v,g]);return r((()=>{if(!e||!S.current)return;const t=S.current,o=()=>{h&&E()},n=()=>{h&&E()},r=()=>{if(h){const e=Math.floor(2*t.currentTime)/2;t.lastDrawnTime!==e&&(t.lastDrawnTime=e,E())}};return t.addEventListener("play",o),t.addEventListener("seeked",n),t.addEventListener("timeupdate",r),()=>{t.removeEventListener("play",o),t.removeEventListener("seeked",n),t.removeEventListener("timeupdate",r)}}),[e,h,E]),r((()=>{e&&l&&S.current&&(console.log("Video URL changed, loading new video"),S.current.load())}),[e,l]),r((()=>{h?(C.current&&(C.current.style.display="block"),E()):C.current&&(C.current.style.display="none")}),[h,E]),e?(r((()=>{let t;return e&&D.current&&(t=setTimeout((()=>{const e=D.current?.querySelector(".modal-content");e&&(e.classList.remove("scale-95","opacity-0"),e.classList.add("scale-100","opacity-100"),console.log("Modal animation applied"))}),10)),()=>{t&&clearTimeout(t)}}),[e]),s(d("div",{ref:D,id:"video-preview-modal",className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",onClick:e=>{e.target===e.currentTarget&&t()},children:d("div",{className:`modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-out ${e?"scale-100 opacity-100":"scale-95 opacity-0"} w-full md:w-[90%]`,children:[d("div",{className:"flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700",children:[d("h3",{id:"video-preview-title",className:"text-lg font-semibold text-gray-900 dark:text-white",children:c||"Video"}),d("button",{className:"close text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",onClick:t,children:"âœ•"})]}),d("div",{className:"p-4 flex-grow",children:d("div",{className:"relative",children:[d("video",{ref:S,className:"w-full h-auto max-w-full object-contain mx-auto",controls:!0,autoPlay:!0,onError:e=>{console.error("Video error:",e),a("Error loading video. Please try again.","error")},onLoadStart:()=>console.log("Video load started"),onLoadedData:()=>console.log("Video data loaded"),children:l&&d("source",{src:l,type:"video/mp4"})},l),d("canvas",{ref:C,className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{display:"none"}})]})}),d("div",{id:"recordings-controls",className:"mx-4 mb-4 p-4 border border-green-500 rounded-lg bg-white dark:bg-gray-700 shadow-md relative z-10",children:[d("h3",{className:"text-lg font-bold text-center mb-4 text-gray-800 dark:text-white",children:"PLAYBACK CONTROLS"}),d("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-2",children:[d("div",{className:"border-b pb-4 md:border-b-0 md:border-r md:pr-4 md:pb-0",children:[d("h4",{className:"font-bold text-center mb-3 text-gray-700 dark:text-gray-300",children:"Playback Speed"}),d("div",{className:"flex flex-wrap justify-center gap-2",children:[.25,.5,1,1.5,2,4].map((e=>d("button",{className:`speed-btn px-3 py-2 rounded-full ${e===k?"bg-green-500 text-white":"bg-gray-200 hover:bg-gray-300"} text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50`,"data-speed":e,onClick:()=>(e=>{S.current&&(S.current.playbackRate=e,N(e))})(e),children:1===e?"1Ã— (Normal)":`${e}Ã—`},e)))}),d("div",{id:"current-speed-indicator",className:"mt-3 text-center font-medium text-green-600 dark:text-green-400 text-sm",children:["Current Speed: ",k,"Ã— ",1===k?"(Normal)":""]})]}),d("div",{className:"pt-4 md:pt-0 md:pl-4",children:[d("h4",{className:"font-bold text-center mb-2 text-gray-700 dark:text-gray-300",children:"Detection Overlays"}),d("div",{className:"flex flex-col items-center gap-2",children:[d("div",{className:"flex items-center gap-2 mb-2",children:[d("input",{type:"checkbox",id:"detection-overlay-checkbox",className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600",checked:h,onChange:e=>u(e.target.checked),disabled:0===w.length}),d("label",{htmlFor:"detection-overlay-checkbox",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Show Detection Overlays"})]}),d("div",{className:"flex flex-col w-full mt-2 mb-2",children:[d("label",{htmlFor:"detection-sensitivity-slider",className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Detection Sensitivity"}),d("input",{type:"range",id:"detection-sensitivity-slider",className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700",min:"1",max:"10",step:"1",value:g,onChange:e=>{const t=parseInt(e.target.value,10);p(t),h&&E()}}),d("div",{id:"detection-sensitivity-value",className:"text-xs text-gray-600 dark:text-gray-400 text-center mb-1",children:["Time Window: ",g," second",1!==g?"s":""]})]}),d("div",{id:"detection-status-indicator",className:"text-center text-sm "+(w.length>0?"font-medium text-green-600 dark:text-green-400":"text-gray-600 dark:text-gray-400"),children:b})]})]})]}),m&&d("div",{className:"flex justify-center mt-4 pt-2 border-t border-gray-200 dark:border-gray-700",children:d("a",{className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center text-sm",href:m,download:`video-${Date.now()}.mp4`,children:[d("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:d("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Download Video"]})})]}),d("div",{className:"p-2"})]})}),document.body)):null}function v(e,o){if(console.warn("Direct showSnapshotPreview() is deprecated. Use ModalContext.showSnapshotPreview instead."),window.__modalContext&&window.__modalContext.showSnapshotPreview)return void window.__modalContext.showSnapshotPreview(e,o);if(!document.getElementById("modal-root")){const e=document.createElement("div");e.id="modal-root",document.body.appendChild(e)}const n=document.createElement("div");n.id="temp-snapshot-container",document.body.appendChild(n),c((async()=>{const{render:e,h:o}=await t.import("./query-client-legacy-_zrrCFf8.js").then((e=>e.p));return{render:e,h:o}}),void 0,t.meta.url).then((({render:r,h:d})=>{r(d(w,{isOpen:!0,onClose:()=>{r(null,n),document.body.removeChild(n)},imageData:e,streamName:o,onDownload:()=>{try{c((async()=>{const{useSnapshotManager:e}=await Promise.resolve().then((()=>g));return{useSnapshotManager:e}}),void 0,t.meta.url).then((({useSnapshotManager:t})=>{const{downloadSnapshot:n}=t();if(n)n();else{const t=(new Date).toISOString().replace(/[:.]/g,"-"),n=`snapshot_${o}_${t}.jpg`,r=document.createElement("a");r.href=e,r.download=n,document.body.appendChild(r),r.click(),setTimeout((()=>{document.body.removeChild(r)}),100),a("Snapshot downloaded successfully","success",3e3)}})).catch((t=>{console.error("Error importing SnapshotManager:",t);const n=(new Date).toISOString().replace(/[:.]/g,"-"),r=`snapshot_${o}_${n}.jpg`,d=document.createElement("a");d.href=e,d.download=r,document.body.appendChild(d),d.click(),setTimeout((()=>{document.body.removeChild(d)}),100),a("Snapshot downloaded successfully","success",3e3)}))}catch(n){console.error("Error downloading snapshot:",n),a("Download failed: "+n.message,"error",5e3)}}}),n)})).catch((e=>{console.error("Error rendering snapshot modal:",e),a("Error showing snapshot preview: "+e.message,"error")}))}}}}));
//# sourceMappingURL=UI-legacy-DgahnTAI.js.map
